/**
* @license
* author: Nikolay Ryabov
* flame-chart-js v2.3.1
* Released under the MIT license.
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).flameChartJs=e.flameChartJs||{})}(this,(function(e){"use strict";function t(){}function i(){i.init.call(this)}function n(e){return void 0===e._maxListeners?i.defaultMaxListeners:e._maxListeners}function s(e,t,i){if(t)e.call(i);else for(var n=e.length,s=u(e,n),r=0;r<n;++r)s[r].call(i)}function r(e,t,i,n){if(t)e.call(i,n);else for(var s=e.length,r=u(e,s),o=0;o<s;++o)r[o].call(i,n)}function o(e,t,i,n,s){if(t)e.call(i,n,s);else for(var r=e.length,o=u(e,r),h=0;h<r;++h)o[h].call(i,n,s)}function h(e,t,i,n,s,r){if(t)e.call(i,n,s,r);else for(var o=e.length,h=u(e,o),a=0;a<o;++a)h[a].call(i,n,s,r)}function a(e,t,i,n){if(t)e.apply(i,n);else for(var s=e.length,r=u(e,s),o=0;o<s;++o)r[o].apply(i,n)}function l(e,i,s,r){var o,h,a,l;if("function"!=typeof s)throw new TypeError('"listener" argument must be a function');if((h=e._events)?(h.newListener&&(e.emit("newListener",i,s.listener?s.listener:s),h=e._events),a=h[i]):(h=e._events=new t,e._eventsCount=0),a){if("function"==typeof a?a=h[i]=r?[s,a]:[a,s]:r?a.unshift(s):a.push(s),!a.warned&&(o=n(e))&&o>0&&a.length>o){a.warned=!0;var d=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+i+" listeners added. Use emitter.setMaxListeners() to increase limit");d.name="MaxListenersExceededWarning",d.emitter=e,d.type=i,d.count=a.length,l=d,"function"==typeof console.warn?console.warn(l):console.log(l)}}else a=h[i]=s,++e._eventsCount;return e}function d(e,t,i){var n=!1;function s(){e.removeListener(t,s),n||(n=!0,i.apply(e,arguments))}return s.listener=i,s}function c(e){var t=this._events;if(t){var i=t[e];if("function"==typeof i)return 1;if(i)return i.length}return 0}function u(e,t){for(var i=new Array(t);t--;)i[t]=e[t];return i}t.prototype=Object.create(null),i.EventEmitter=i,i.usingDomains=!1,i.prototype.domain=void 0,i.prototype._events=void 0,i.prototype._maxListeners=void 0,i.defaultMaxListeners=10,i.init=function(){this.domain=null,i.usingDomains&&undefined.active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new t,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},i.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},i.prototype.getMaxListeners=function(){return n(this)},i.prototype.emit=function(e){var t,i,n,l,d,c,u,g="error"===e;if(c=this._events)g=g&&null==c.error;else if(!g)return!1;if(u=this.domain,g){if(t=arguments[1],!u){if(t instanceof Error)throw t;var m=new Error('Uncaught, unspecified "error" event. ('+t+")");throw m.context=t,m}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=u,t.domainThrown=!1,u.emit("error",t),!1}if(!(i=c[e]))return!1;var p="function"==typeof i;switch(n=arguments.length){case 1:s(i,p,this);break;case 2:r(i,p,this,arguments[1]);break;case 3:o(i,p,this,arguments[1],arguments[2]);break;case 4:h(i,p,this,arguments[1],arguments[2],arguments[3]);break;default:for(l=new Array(n-1),d=1;d<n;d++)l[d-1]=arguments[d];a(i,p,this,l)}return!0},i.prototype.addListener=function(e,t){return l(this,e,t,!1)},i.prototype.on=i.prototype.addListener,i.prototype.prependListener=function(e,t){return l(this,e,t,!0)},i.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,d(this,e,t)),this},i.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,d(this,e,t)),this},i.prototype.removeListener=function(e,i){var n,s,r,o,h;if("function"!=typeof i)throw new TypeError('"listener" argument must be a function');if(!(s=this._events))return this;if(!(n=s[e]))return this;if(n===i||n.listener&&n.listener===i)0==--this._eventsCount?this._events=new t:(delete s[e],s.removeListener&&this.emit("removeListener",e,n.listener||i));else if("function"!=typeof n){for(r=-1,o=n.length;o-- >0;)if(n[o]===i||n[o].listener&&n[o].listener===i){h=n[o].listener,r=o;break}if(r<0)return this;if(1===n.length){if(n[0]=void 0,0==--this._eventsCount)return this._events=new t,this;delete s[e]}else!function(e,t){for(var i=t,n=i+1,s=e.length;n<s;i+=1,n+=1)e[i]=e[n];e.pop()}(n,r);s.removeListener&&this.emit("removeListener",e,h||i)}return this},i.prototype.removeAllListeners=function(e){var i,n;if(!(n=this._events))return this;if(!n.removeListener)return 0===arguments.length?(this._events=new t,this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=new t:delete n[e]),this;if(0===arguments.length){for(var s,r=Object.keys(n),o=0;o<r.length;++o)"removeListener"!==(s=r[o])&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=new t,this._eventsCount=0,this}if("function"==typeof(i=n[e]))this.removeListener(e,i);else if(i)do{this.removeListener(e,i[i.length-1])}while(i[0]);return this},i.prototype.listeners=function(e){var t,i=this._events;return i&&(t=i[e])?"function"==typeof t?[t.listener||t]:function(e){for(var t=new Array(e.length),i=0;i<t.length;++i)t[i]=e[i].listener||e[i];return t}(t):[]},i.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):c.call(e,t)},i.prototype.listenerCount=c,i.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};class g extends i{constructor(e){super(),this.name=e}init(e,t){this.renderEngine=e,this.interactionsEngine=t}}const m=(e,t={})=>Object.keys(e).reduce(((i,n)=>(t[n]?i[n]=t[n]:i[n]=e[n],i)),{}),p=e=>"number"==typeof e,f=e=>e[e.length-1],v=(e,t,i=null,n=0)=>{e.forEach((e=>{const s=t(e,i,n);e.children&&v(e.children,t,s||e,n+1)}))},y=e=>{const t=[];let i=0;return v(e,((e,n,s)=>{const r={source:e,end:e.start+e.duration,parent:n,level:s,index:i++};return t.push(r),r})),t.sort(((e,t)=>e.level-t.level||e.source.start-t.source.start))},x=e=>{let t=!0,i=0,n=0;return e.forEach((({source:{start:e},end:s})=>{t?(i=e,n=s,t=!1):(i=i<e?i:e,n=n>s?n:s)})),{min:i,max:n}},E=(e,t,i)=>e.source.start<i&&e.end>t||e.source.start>t&&e.end<i,b=(e,t)=>e.source.color===t.source.color&&e.source.type===t.source.type;function w(e,t=b){return e.reduce(((e,i)=>{const n=f(e),s=n&&f(n);return s&&s.level===i.level&&t(s,i)?n.push(i):e.push([i]),e}),[]).filter((e=>e.length)).map((e=>({nodes:e})))}const C=(e,t,i=0,n=0,s=.25,r=1)=>{let o=null,h=null,a=0;return e.reduce(((e,{nodes:l})=>{o=null,h=null,a=0;for(const d of l)E(d,i,n)&&(o&&!h||o&&h&&(d.source.start-(h.source.start+h.source.duration))*t<s&&d.source.duration*t<r&&h.source.duration*t<r?(o[a]=d,a++):(o=[d],a=1,e.push(o)),h=d);return e}),[]).map((e=>{const t=e[0],i=(e=>{const t=e[0],i=f(e);return i.source.start+i.source.duration-t.source.start})(e);return{start:t.source.start,end:t.source.start+i,duration:i,type:t.source.type,color:t.source.color,level:t.level,nodes:e}}))},M=(e,t,i,n,s,r)=>e.reduce(((e,o)=>(((e,t,i)=>e.start<i&&e.end>t||e.start>t&&e.end<i)(o,i,n)&&(o.duration*t<=2.25?e.push(o):e.push(...C([o],t,i,n,s,r))),e)),[]);var R={},k={get exports(){return R},set exports(e){R=e}},T={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},S={},P={get exports(){return S},set exports(e){S=e}},z=function(e){return!(!e||"string"==typeof e)&&(e instanceof Array||Array.isArray(e)||e.length>=0&&(e.splice instanceof Function||Object.getOwnPropertyDescriptor(e,e.length-1)&&"String"!==e.constructor.name))},F=Array.prototype.concat,L=Array.prototype.slice,H=P.exports=function(e){for(var t=[],i=0,n=e.length;i<n;i++){var s=e[i];z(s)?t=F.call(t,L.call(s)):t.push(s)}return t};H.wrap=function(e){return function(){return e(H(arguments))}};var D=T,A=S,G=Object.hasOwnProperty,X=Object.create(null);for(var O in D)G.call(D,O)&&(X[D[O]]=O);var V=k.exports={to:{},get:{}};function U(e,t,i){return Math.min(Math.max(t,e),i)}function I(e){var t=Math.round(e).toString(16).toUpperCase();return t.length<2?"0"+t:t}V.get=function(e){var t,i;switch(e.substring(0,3).toLowerCase()){case"hsl":t=V.get.hsl(e),i="hsl";break;case"hwb":t=V.get.hwb(e),i="hwb";break;default:t=V.get.rgb(e),i="rgb"}return t?{model:i,value:t}:null},V.get.rgb=function(e){if(!e)return null;var t,i,n,s=[0,0,0,1];if(t=e.match(/^#([a-f0-9]{6})([a-f0-9]{2})?$/i)){for(n=t[2],t=t[1],i=0;i<3;i++){var r=2*i;s[i]=parseInt(t.slice(r,r+2),16)}n&&(s[3]=parseInt(n,16)/255)}else if(t=e.match(/^#([a-f0-9]{3,4})$/i)){for(n=(t=t[1])[3],i=0;i<3;i++)s[i]=parseInt(t[i]+t[i],16);n&&(s[3]=parseInt(n+n,16)/255)}else if(t=e.match(/^rgba?\(\s*([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)){for(i=0;i<3;i++)s[i]=parseInt(t[i+1],0);t[4]&&(t[5]?s[3]=.01*parseFloat(t[4]):s[3]=parseFloat(t[4]))}else{if(!(t=e.match(/^rgba?\(\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)))return(t=e.match(/^(\w+)$/))?"transparent"===t[1]?[0,0,0,0]:G.call(D,t[1])?((s=D[t[1]])[3]=1,s):null:null;for(i=0;i<3;i++)s[i]=Math.round(2.55*parseFloat(t[i+1]));t[4]&&(t[5]?s[3]=.01*parseFloat(t[4]):s[3]=parseFloat(t[4]))}for(i=0;i<3;i++)s[i]=U(s[i],0,255);return s[3]=U(s[3],0,1),s},V.get.hsl=function(e){if(!e)return null;var t=e.match(/^hsla?\(\s*([+-]?(?:\d{0,3}\.)?\d+)(?:deg)?\s*,?\s*([+-]?[\d\.]+)%\s*,?\s*([+-]?[\d\.]+)%\s*(?:[,|\/]\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(t){var i=parseFloat(t[4]);return[(parseFloat(t[1])%360+360)%360,U(parseFloat(t[2]),0,100),U(parseFloat(t[3]),0,100),U(isNaN(i)?1:i,0,1)]}return null},V.get.hwb=function(e){if(!e)return null;var t=e.match(/^hwb\(\s*([+-]?\d{0,3}(?:\.\d+)?)(?:deg)?\s*,\s*([+-]?[\d\.]+)%\s*,\s*([+-]?[\d\.]+)%\s*(?:,\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(t){var i=parseFloat(t[4]);return[(parseFloat(t[1])%360+360)%360,U(parseFloat(t[2]),0,100),U(parseFloat(t[3]),0,100),U(isNaN(i)?1:i,0,1)]}return null},V.to.hex=function(){var e=A(arguments);return"#"+I(e[0])+I(e[1])+I(e[2])+(e[3]<1?I(Math.round(255*e[3])):"")},V.to.rgb=function(){var e=A(arguments);return e.length<4||1===e[3]?"rgb("+Math.round(e[0])+", "+Math.round(e[1])+", "+Math.round(e[2])+")":"rgba("+Math.round(e[0])+", "+Math.round(e[1])+", "+Math.round(e[2])+", "+e[3]+")"},V.to.rgb.percent=function(){var e=A(arguments),t=Math.round(e[0]/255*100),i=Math.round(e[1]/255*100),n=Math.round(e[2]/255*100);return e.length<4||1===e[3]?"rgb("+t+"%, "+i+"%, "+n+"%)":"rgba("+t+"%, "+i+"%, "+n+"%, "+e[3]+")"},V.to.hsl=function(){var e=A(arguments);return e.length<4||1===e[3]?"hsl("+e[0]+", "+e[1]+"%, "+e[2]+"%)":"hsla("+e[0]+", "+e[1]+"%, "+e[2]+"%, "+e[3]+")"},V.to.hwb=function(){var e=A(arguments),t="";return e.length>=4&&1!==e[3]&&(t=", "+e[3]),"hwb("+e[0]+", "+e[1]+"%, "+e[2]+"%"+t+")"},V.to.keyword=function(e){return X[e.slice(0,3)]};var N={},_={get exports(){return N},set exports(e){N=e}},j=T,Q={};for(var Y in j)j.hasOwnProperty(Y)&&(Q[j[Y]]=Y);var W=_.exports={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};for(var $ in W)if(W.hasOwnProperty($)){if(!("channels"in W[$]))throw new Error("missing channels property: "+$);if(!("labels"in W[$]))throw new Error("missing channel labels property: "+$);if(W[$].labels.length!==W[$].channels)throw new Error("channel and label counts mismatch: "+$);var K=W[$].channels,B=W[$].labels;delete W[$].channels,delete W[$].labels,Object.defineProperty(W[$],"channels",{value:K}),Object.defineProperty(W[$],"labels",{value:B})}W.rgb.hsl=function(e){var t,i,n=e[0]/255,s=e[1]/255,r=e[2]/255,o=Math.min(n,s,r),h=Math.max(n,s,r),a=h-o;return h===o?t=0:n===h?t=(s-r)/a:s===h?t=2+(r-n)/a:r===h&&(t=4+(n-s)/a),(t=Math.min(60*t,360))<0&&(t+=360),i=(o+h)/2,[t,100*(h===o?0:i<=.5?a/(h+o):a/(2-h-o)),100*i]},W.rgb.hsv=function(e){var t,i,n,s,r,o=e[0]/255,h=e[1]/255,a=e[2]/255,l=Math.max(o,h,a),d=l-Math.min(o,h,a),c=function(e){return(l-e)/6/d+.5};return 0===d?s=r=0:(r=d/l,t=c(o),i=c(h),n=c(a),o===l?s=n-i:h===l?s=1/3+t-n:a===l&&(s=2/3+i-t),s<0?s+=1:s>1&&(s-=1)),[360*s,100*r,100*l]},W.rgb.hwb=function(e){var t=e[0],i=e[1],n=e[2];return[W.rgb.hsl(e)[0],100*(1/255*Math.min(t,Math.min(i,n))),100*(n=1-1/255*Math.max(t,Math.max(i,n)))]},W.rgb.cmyk=function(e){var t,i=e[0]/255,n=e[1]/255,s=e[2]/255;return[100*((1-i-(t=Math.min(1-i,1-n,1-s)))/(1-t)||0),100*((1-n-t)/(1-t)||0),100*((1-s-t)/(1-t)||0),100*t]},W.rgb.keyword=function(e){var t=Q[e];if(t)return t;var i,n,s,r=1/0;for(var o in j)if(j.hasOwnProperty(o)){var h=j[o],a=(n=e,s=h,Math.pow(n[0]-s[0],2)+Math.pow(n[1]-s[1],2)+Math.pow(n[2]-s[2],2));a<r&&(r=a,i=o)}return i},W.keyword.rgb=function(e){return j[e]},W.rgb.xyz=function(e){var t=e[0]/255,i=e[1]/255,n=e[2]/255;return[100*(.4124*(t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92)+.3576*(i=i>.04045?Math.pow((i+.055)/1.055,2.4):i/12.92)+.1805*(n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92)),100*(.2126*t+.7152*i+.0722*n),100*(.0193*t+.1192*i+.9505*n)]},W.rgb.lab=function(e){var t=W.rgb.xyz(e),i=t[0],n=t[1],s=t[2];return n/=100,s/=108.883,i=(i/=95.047)>.008856?Math.pow(i,1/3):7.787*i+16/116,[116*(n=n>.008856?Math.pow(n,1/3):7.787*n+16/116)-16,500*(i-n),200*(n-(s=s>.008856?Math.pow(s,1/3):7.787*s+16/116))]},W.hsl.rgb=function(e){var t,i,n,s,r,o=e[0]/360,h=e[1]/100,a=e[2]/100;if(0===h)return[r=255*a,r,r];t=2*a-(i=a<.5?a*(1+h):a+h-a*h),s=[0,0,0];for(var l=0;l<3;l++)(n=o+1/3*-(l-1))<0&&n++,n>1&&n--,r=6*n<1?t+6*(i-t)*n:2*n<1?i:3*n<2?t+(i-t)*(2/3-n)*6:t,s[l]=255*r;return s},W.hsl.hsv=function(e){var t=e[0],i=e[1]/100,n=e[2]/100,s=i,r=Math.max(n,.01);return i*=(n*=2)<=1?n:2-n,s*=r<=1?r:2-r,[t,100*(0===n?2*s/(r+s):2*i/(n+i)),100*((n+i)/2)]},W.hsv.rgb=function(e){var t=e[0]/60,i=e[1]/100,n=e[2]/100,s=Math.floor(t)%6,r=t-Math.floor(t),o=255*n*(1-i),h=255*n*(1-i*r),a=255*n*(1-i*(1-r));switch(n*=255,s){case 0:return[n,a,o];case 1:return[h,n,o];case 2:return[o,n,a];case 3:return[o,h,n];case 4:return[a,o,n];case 5:return[n,o,h]}},W.hsv.hsl=function(e){var t,i,n,s=e[0],r=e[1]/100,o=e[2]/100,h=Math.max(o,.01);return n=(2-r)*o,i=r*h,[s,100*(i=(i/=(t=(2-r)*h)<=1?t:2-t)||0),100*(n/=2)]},W.hwb.rgb=function(e){var t,i,n,s,r,o,h,a=e[0]/360,l=e[1]/100,d=e[2]/100,c=l+d;switch(c>1&&(l/=c,d/=c),n=6*a-(t=Math.floor(6*a)),0!=(1&t)&&(n=1-n),s=l+n*((i=1-d)-l),t){default:case 6:case 0:r=i,o=s,h=l;break;case 1:r=s,o=i,h=l;break;case 2:r=l,o=i,h=s;break;case 3:r=l,o=s,h=i;break;case 4:r=s,o=l,h=i;break;case 5:r=i,o=l,h=s}return[255*r,255*o,255*h]},W.cmyk.rgb=function(e){var t=e[0]/100,i=e[1]/100,n=e[2]/100,s=e[3]/100;return[255*(1-Math.min(1,t*(1-s)+s)),255*(1-Math.min(1,i*(1-s)+s)),255*(1-Math.min(1,n*(1-s)+s))]},W.xyz.rgb=function(e){var t,i,n,s=e[0]/100,r=e[1]/100,o=e[2]/100;return i=-.9689*s+1.8758*r+.0415*o,n=.0557*s+-.204*r+1.057*o,t=(t=3.2406*s+-1.5372*r+-.4986*o)>.0031308?1.055*Math.pow(t,1/2.4)-.055:12.92*t,i=i>.0031308?1.055*Math.pow(i,1/2.4)-.055:12.92*i,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:12.92*n,[255*(t=Math.min(Math.max(0,t),1)),255*(i=Math.min(Math.max(0,i),1)),255*(n=Math.min(Math.max(0,n),1))]},W.xyz.lab=function(e){var t=e[0],i=e[1],n=e[2];return i/=100,n/=108.883,t=(t/=95.047)>.008856?Math.pow(t,1/3):7.787*t+16/116,[116*(i=i>.008856?Math.pow(i,1/3):7.787*i+16/116)-16,500*(t-i),200*(i-(n=n>.008856?Math.pow(n,1/3):7.787*n+16/116))]},W.lab.xyz=function(e){var t,i,n,s=e[0];t=e[1]/500+(i=(s+16)/116),n=i-e[2]/200;var r=Math.pow(i,3),o=Math.pow(t,3),h=Math.pow(n,3);return i=r>.008856?r:(i-16/116)/7.787,t=o>.008856?o:(t-16/116)/7.787,n=h>.008856?h:(n-16/116)/7.787,[t*=95.047,i*=100,n*=108.883]},W.lab.lch=function(e){var t,i=e[0],n=e[1],s=e[2];return(t=360*Math.atan2(s,n)/2/Math.PI)<0&&(t+=360),[i,Math.sqrt(n*n+s*s),t]},W.lch.lab=function(e){var t,i=e[0],n=e[1];return t=e[2]/360*2*Math.PI,[i,n*Math.cos(t),n*Math.sin(t)]},W.rgb.ansi16=function(e){var t=e[0],i=e[1],n=e[2],s=1 in arguments?arguments[1]:W.rgb.hsv(e)[2];if(0===(s=Math.round(s/50)))return 30;var r=30+(Math.round(n/255)<<2|Math.round(i/255)<<1|Math.round(t/255));return 2===s&&(r+=60),r},W.hsv.ansi16=function(e){return W.rgb.ansi16(W.hsv.rgb(e),e[2])},W.rgb.ansi256=function(e){var t=e[0],i=e[1],n=e[2];return t===i&&i===n?t<8?16:t>248?231:Math.round((t-8)/247*24)+232:16+36*Math.round(t/255*5)+6*Math.round(i/255*5)+Math.round(n/255*5)},W.ansi16.rgb=function(e){var t=e%10;if(0===t||7===t)return e>50&&(t+=3.5),[t=t/10.5*255,t,t];var i=.5*(1+~~(e>50));return[(1&t)*i*255,(t>>1&1)*i*255,(t>>2&1)*i*255]},W.ansi256.rgb=function(e){if(e>=232){var t=10*(e-232)+8;return[t,t,t]}var i;return e-=16,[Math.floor(e/36)/5*255,Math.floor((i=e%36)/6)/5*255,i%6/5*255]},W.rgb.hex=function(e){var t=(((255&Math.round(e[0]))<<16)+((255&Math.round(e[1]))<<8)+(255&Math.round(e[2]))).toString(16).toUpperCase();return"000000".substring(t.length)+t},W.hex.rgb=function(e){var t=e.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!t)return[0,0,0];var i=t[0];3===t[0].length&&(i=i.split("").map((function(e){return e+e})).join(""));var n=parseInt(i,16);return[n>>16&255,n>>8&255,255&n]},W.rgb.hcg=function(e){var t,i=e[0]/255,n=e[1]/255,s=e[2]/255,r=Math.max(Math.max(i,n),s),o=Math.min(Math.min(i,n),s),h=r-o;return t=h<=0?0:r===i?(n-s)/h%6:r===n?2+(s-i)/h:4+(i-n)/h+4,t/=6,[360*(t%=1),100*h,100*(h<1?o/(1-h):0)]},W.hsl.hcg=function(e){var t=e[1]/100,i=e[2]/100,n=1,s=0;return(n=i<.5?2*t*i:2*t*(1-i))<1&&(s=(i-.5*n)/(1-n)),[e[0],100*n,100*s]},W.hsv.hcg=function(e){var t=e[1]/100,i=e[2]/100,n=t*i,s=0;return n<1&&(s=(i-n)/(1-n)),[e[0],100*n,100*s]},W.hcg.rgb=function(e){var t=e[0]/360,i=e[1]/100,n=e[2]/100;if(0===i)return[255*n,255*n,255*n];var s,r=[0,0,0],o=t%1*6,h=o%1,a=1-h;switch(Math.floor(o)){case 0:r[0]=1,r[1]=h,r[2]=0;break;case 1:r[0]=a,r[1]=1,r[2]=0;break;case 2:r[0]=0,r[1]=1,r[2]=h;break;case 3:r[0]=0,r[1]=a,r[2]=1;break;case 4:r[0]=h,r[1]=0,r[2]=1;break;default:r[0]=1,r[1]=0,r[2]=a}return s=(1-i)*n,[255*(i*r[0]+s),255*(i*r[1]+s),255*(i*r[2]+s)]},W.hcg.hsv=function(e){var t=e[1]/100,i=t+e[2]/100*(1-t),n=0;return i>0&&(n=t/i),[e[0],100*n,100*i]},W.hcg.hsl=function(e){var t=e[1]/100,i=e[2]/100*(1-t)+.5*t,n=0;return i>0&&i<.5?n=t/(2*i):i>=.5&&i<1&&(n=t/(2*(1-i))),[e[0],100*n,100*i]},W.hcg.hwb=function(e){var t=e[1]/100,i=t+e[2]/100*(1-t);return[e[0],100*(i-t),100*(1-i)]},W.hwb.hcg=function(e){var t=e[1]/100,i=1-e[2]/100,n=i-t,s=0;return n<1&&(s=(i-n)/(1-n)),[e[0],100*n,100*s]},W.apple.rgb=function(e){return[e[0]/65535*255,e[1]/65535*255,e[2]/65535*255]},W.rgb.apple=function(e){return[e[0]/255*65535,e[1]/255*65535,e[2]/255*65535]},W.gray.rgb=function(e){return[e[0]/100*255,e[0]/100*255,e[0]/100*255]},W.gray.hsl=W.gray.hsv=function(e){return[0,0,e[0]]},W.gray.hwb=function(e){return[0,100,e[0]]},W.gray.cmyk=function(e){return[0,0,0,e[0]]},W.gray.lab=function(e){return[e[0],0,0]},W.gray.hex=function(e){var t=255&Math.round(e[0]/100*255),i=((t<<16)+(t<<8)+t).toString(16).toUpperCase();return"000000".substring(i.length)+i},W.rgb.gray=function(e){return[(e[0]+e[1]+e[2])/3/255*100]};var Z=N;function q(e){var t=function(){for(var e={},t=Object.keys(Z),i=t.length,n=0;n<i;n++)e[t[n]]={distance:-1,parent:null};return e}(),i=[e];for(t[e].distance=0;i.length;)for(var n=i.pop(),s=Object.keys(Z[n]),r=s.length,o=0;o<r;o++){var h=s[o],a=t[h];-1===a.distance&&(a.distance=t[n].distance+1,a.parent=n,i.unshift(h))}return t}function J(e,t){return function(i){return t(e(i))}}function ee(e,t){for(var i=[t[e].parent,e],n=Z[t[e].parent][e],s=t[e].parent;t[s].parent;)i.unshift(t[s].parent),n=J(Z[t[s].parent][s],n),s=t[s].parent;return n.conversion=i,n}var te=N,ie=function(e){for(var t=q(e),i={},n=Object.keys(t),s=n.length,r=0;r<s;r++){var o=n[r];null!==t[o].parent&&(i[o]=ee(o,t))}return i},ne={};Object.keys(te).forEach((function(e){ne[e]={},Object.defineProperty(ne[e],"channels",{value:te[e].channels}),Object.defineProperty(ne[e],"labels",{value:te[e].labels});var t=ie(e);Object.keys(t).forEach((function(i){var n=t[i];ne[e][i]=function(e){var t=function(t){if(null==t)return t;arguments.length>1&&(t=Array.prototype.slice.call(arguments));var i=e(t);if("object"==typeof i)for(var n=i.length,s=0;s<n;s++)i[s]=Math.round(i[s]);return i};return"conversion"in e&&(t.conversion=e.conversion),t}(n),ne[e][i].raw=function(e){var t=function(t){return null==t?t:(arguments.length>1&&(t=Array.prototype.slice.call(arguments)),e(t))};return"conversion"in e&&(t.conversion=e.conversion),t}(n)}))}));var se=R,re=ne,oe=[].slice,he=["keyword","gray","hex"],ae={};Object.keys(re).forEach((function(e){ae[oe.call(re[e].labels).sort().join("")]=e}));var le={};function de(e,t){if(!(this instanceof de))return new de(e,t);if(t&&t in he&&(t=null),t&&!(t in re))throw new Error("Unknown model: "+t);var i,n;if(null==e)this.model="rgb",this.color=[0,0,0],this.valpha=1;else if(e instanceof de)this.model=e.model,this.color=e.color.slice(),this.valpha=e.valpha;else if("string"==typeof e){var s=se.get(e);if(null===s)throw new Error("Unable to parse color from string: "+e);this.model=s.model,n=re[this.model].channels,this.color=s.value.slice(0,n),this.valpha="number"==typeof s.value[n]?s.value[n]:1}else if(e.length){this.model=t||"rgb",n=re[this.model].channels;var r=oe.call(e,0,n);this.color=me(r,n),this.valpha="number"==typeof e[n]?e[n]:1}else if("number"==typeof e)e&=16777215,this.model="rgb",this.color=[e>>16&255,e>>8&255,255&e],this.valpha=1;else{this.valpha=1;var o=Object.keys(e);"alpha"in e&&(o.splice(o.indexOf("alpha"),1),this.valpha="number"==typeof e.alpha?e.alpha:0);var h=o.sort().join("");if(!(h in ae))throw new Error("Unable to parse color from object: "+JSON.stringify(e));this.model=ae[h];var a=re[this.model].labels,l=[];for(i=0;i<a.length;i++)l.push(e[a[i]]);this.color=me(l)}if(le[this.model])for(n=re[this.model].channels,i=0;i<n;i++){var d=le[this.model][i];d&&(this.color[i]=d(this.color[i]))}this.valpha=Math.max(0,Math.min(1,this.valpha)),Object.freeze&&Object.freeze(this)}function ce(e,t,i){return(e=Array.isArray(e)?e:[e]).forEach((function(e){(le[e]||(le[e]=[]))[t]=i})),e=e[0],function(n){var s;return arguments.length?(i&&(n=i(n)),(s=this[e]()).color[t]=n,s):(s=this[e]().color[t],i&&(s=i(s)),s)}}function ue(e){return function(t){return Math.max(0,Math.min(e,t))}}function ge(e){return Array.isArray(e)?e:[e]}function me(e,t){for(var i=0;i<t;i++)"number"!=typeof e[i]&&(e[i]=0);return e}de.prototype={toString:function(){return this.string()},toJSON:function(){return this[this.model]()},string:function(e){var t=this.model in se.to?this:this.rgb(),i=1===(t=t.round("number"==typeof e?e:1)).valpha?t.color:t.color.concat(this.valpha);return se.to[t.model](i)},percentString:function(e){var t=this.rgb().round("number"==typeof e?e:1),i=1===t.valpha?t.color:t.color.concat(this.valpha);return se.to.rgb.percent(i)},array:function(){return 1===this.valpha?this.color.slice():this.color.concat(this.valpha)},object:function(){for(var e={},t=re[this.model].channels,i=re[this.model].labels,n=0;n<t;n++)e[i[n]]=this.color[n];return 1!==this.valpha&&(e.alpha=this.valpha),e},unitArray:function(){var e=this.rgb().color;return e[0]/=255,e[1]/=255,e[2]/=255,1!==this.valpha&&e.push(this.valpha),e},unitObject:function(){var e=this.rgb().object();return e.r/=255,e.g/=255,e.b/=255,1!==this.valpha&&(e.alpha=this.valpha),e},round:function(e){return e=Math.max(e||0,0),new de(this.color.map(function(e){return function(t){return function(e,t){return Number(e.toFixed(t))}(t,e)}}(e)).concat(this.valpha),this.model)},alpha:function(e){return arguments.length?new de(this.color.concat(Math.max(0,Math.min(1,e))),this.model):this.valpha},red:ce("rgb",0,ue(255)),green:ce("rgb",1,ue(255)),blue:ce("rgb",2,ue(255)),hue:ce(["hsl","hsv","hsl","hwb","hcg"],0,(function(e){return(e%360+360)%360})),saturationl:ce("hsl",1,ue(100)),lightness:ce("hsl",2,ue(100)),saturationv:ce("hsv",1,ue(100)),value:ce("hsv",2,ue(100)),chroma:ce("hcg",1,ue(100)),gray:ce("hcg",2,ue(100)),white:ce("hwb",1,ue(100)),wblack:ce("hwb",2,ue(100)),cyan:ce("cmyk",0,ue(100)),magenta:ce("cmyk",1,ue(100)),yellow:ce("cmyk",2,ue(100)),black:ce("cmyk",3,ue(100)),x:ce("xyz",0,ue(100)),y:ce("xyz",1,ue(100)),z:ce("xyz",2,ue(100)),l:ce("lab",0,ue(100)),a:ce("lab",1),b:ce("lab",2),keyword:function(e){return arguments.length?new de(e):re[this.model].keyword(this.color)},hex:function(e){return arguments.length?new de(e):se.to.hex(this.rgb().round().color)},rgbNumber:function(){var e=this.rgb().color;return(255&e[0])<<16|(255&e[1])<<8|255&e[2]},luminosity:function(){for(var e=this.rgb().color,t=[],i=0;i<e.length;i++){var n=e[i]/255;t[i]=n<=.03928?n/12.92:Math.pow((n+.055)/1.055,2.4)}return.2126*t[0]+.7152*t[1]+.0722*t[2]},contrast:function(e){var t=this.luminosity(),i=e.luminosity();return t>i?(t+.05)/(i+.05):(i+.05)/(t+.05)},level:function(e){var t=this.contrast(e);return t>=7.1?"AAA":t>=4.5?"AA":""},isDark:function(){var e=this.rgb().color;return(299*e[0]+587*e[1]+114*e[2])/1e3<128},isLight:function(){return!this.isDark()},negate:function(){for(var e=this.rgb(),t=0;t<3;t++)e.color[t]=255-e.color[t];return e},lighten:function(e){var t=this.hsl();return t.color[2]+=t.color[2]*e,t},darken:function(e){var t=this.hsl();return t.color[2]-=t.color[2]*e,t},saturate:function(e){var t=this.hsl();return t.color[1]+=t.color[1]*e,t},desaturate:function(e){var t=this.hsl();return t.color[1]-=t.color[1]*e,t},whiten:function(e){var t=this.hwb();return t.color[1]+=t.color[1]*e,t},blacken:function(e){var t=this.hwb();return t.color[2]+=t.color[2]*e,t},grayscale:function(){var e=this.rgb().color,t=.3*e[0]+.59*e[1]+.11*e[2];return de.rgb(t,t,t)},fade:function(e){return this.alpha(this.valpha-this.valpha*e)},opaquer:function(e){return this.alpha(this.valpha+this.valpha*e)},rotate:function(e){var t=this.hsl(),i=t.color[0];return i=(i=(i+e)%360)<0?360+i:i,t.color[0]=i,t},mix:function(e,t){if(!e||!e.rgb)throw new Error('Argument to "mix" was not a Color instance, but rather an instance of '+typeof e);var i=e.rgb(),n=this.rgb(),s=void 0===t?.5:t,r=2*s-1,o=i.alpha()-n.alpha(),h=((r*o==-1?r:(r+o)/(1+r*o))+1)/2,a=1-h;return de.rgb(h*i.red()+a*n.red(),h*i.green()+a*n.green(),h*i.blue()+a*n.blue(),i.alpha()*s+n.alpha()*(1-s))}},Object.keys(re).forEach((function(e){if(-1===he.indexOf(e)){var t=re[e].channels;de.prototype[e]=function(){if(this.model===e)return new de(this);if(arguments.length)return new de(arguments,e);var i="number"==typeof arguments[t]?t:this.valpha;return new de(ge(re[this.model][e].raw(this.color)).concat(i),e)},de[e]=function(i){return"number"==typeof i&&(i=me(oe.call(arguments),t)),new de(i,e)}}}));var pe=de;const fe=pe.hsl(180,30,70);class ve extends g{constructor({data:e,colors:t={},name:i="flameChartPlugin"}){super(i),this.height=0,this.flatTree=[],this.positionY=0,this.colors={},this.selectedRegion=null,this.hoveredRegion=null,this.lastRandomColor=fe,this.metaClusterizedFlatTree=[],this.actualClusterizedFlatTree=[],this.initialClusterizedFlatTree=[],this.lastUsedColor=null,this.renderChartTimeout=-1,this.data=e,this.userColors=t,this.parseData(),this.reset()}init(e,t){super.init(e,t),this.interactionsEngine.on("change-position",this.handlePositionChange.bind(this)),this.interactionsEngine.on("select",this.handleSelect.bind(this)),this.interactionsEngine.on("hover",this.handleHover.bind(this)),this.interactionsEngine.on("up",this.handleMouseUp.bind(this)),this.initData()}handlePositionChange({deltaX:e,deltaY:t}){const i=this.positionY,n=this.renderEngine.parent.positionX;this.interactionsEngine.setCursor("grabbing"),this.positionY+t>=0?this.setPositionY(this.positionY+t):this.setPositionY(0),this.renderEngine.tryToChangePosition(e),n===this.renderEngine.parent.positionX&&i===this.positionY||this.renderEngine.parent.render()}handleMouseUp(){this.interactionsEngine.clearCursor()}setPositionY(e){this.positionY=e}reset(){this.colors={},this.lastRandomColor=fe,this.positionY=0,this.selectedRegion=null}calcMinMax(){const{flatTree:e}=this,{min:t,max:i}=x(e);this.min=t,this.max=i}handleSelect(e){var t,i;const n=this.findNodeInCluster(e);this.selectedRegion!==n&&(this.selectedRegion=n,this.renderEngine.render(),this.emit("select",{node:null!==(i=null===(t=this.selectedRegion)||void 0===t?void 0:t.data)&&void 0!==i?i:null,type:"flame-chart-node"}))}handleHover(e){this.hoveredRegion=this.findNodeInCluster(e)}findNodeInCluster(e){const t=this.interactionsEngine.getMouse();if(e&&"cluster"===e.type){const i=e.data.nodes.find((({level:e,source:{start:i,duration:n}})=>{const{x:s,y:r,w:o}=this.calcRect(i,n,e);return t.x>=s&&t.x<=s+o&&t.y>=r&&t.y<=r+this.renderEngine.blockHeight}));if(i)return{data:i,type:"node"}}return null}getColor(e="_default",t){if(t)return t;if(this.colors[e])return this.colors[e];if(this.userColors[e]){const t=new pe(this.userColors[e]);return this.colors[e]=t.rgb().toString(),this.colors[e]}return this.lastRandomColor=this.lastRandomColor.rotate(27),this.colors[e]=this.lastRandomColor.rgb().toString(),this.colors[e]}setData(e){this.data=e,this.parseData(),this.initData(),this.reset(),this.renderEngine.recalcMinMax(),this.renderEngine.resetParentView()}parseData(){this.flatTree=y(this.data),this.calcMinMax()}initData(){this.metaClusterizedFlatTree=w(this.flatTree),this.initialClusterizedFlatTree=C(this.metaClusterizedFlatTree,this.renderEngine.zoom,this.min,this.max),this.reclusterizeClusteredFlatTree()}reclusterizeClusteredFlatTree(){this.actualClusterizedFlatTree=M(this.initialClusterizedFlatTree,this.renderEngine.zoom,this.renderEngine.positionX,this.renderEngine.positionX+this.renderEngine.getRealView())}calcRect(e,t,i){const n=t*this.renderEngine.zoom;return{x:this.renderEngine.timeToPosition(e),y:i*(this.renderEngine.blockHeight+1)-this.positionY,w:n<=.1?.1:n>=3?n-1:n-n/3}}renderTooltip(){if(this.hoveredRegion){if(!1===this.renderEngine.options.tooltip)return!0;if("function"==typeof this.renderEngine.options.tooltip)this.renderEngine.options.tooltip(this.hoveredRegion,this.renderEngine,this.interactionsEngine.getGlobalMouse());else{const{data:{source:{start:e,duration:t,name:i,children:n}}}=this.hoveredRegion,s=this.renderEngine.getTimeUnits(),r=t-(n?n.reduce(((e,{duration:t})=>e+t),0):0),o=this.renderEngine.getAccuracy()+2,h=`${i}`,a=`duration: ${t.toFixed(o)} ${s} ${(null==n?void 0:n.length)?`(self ${r.toFixed(o)} ${s})`:""}`,l=`start: ${e.toFixed(o)}`;this.renderEngine.renderTooltipFromData([{text:h},{text:a},{text:l}],this.interactionsEngine.getGlobalMouse())}return!0}return!1}render(){const{width:e,blockHeight:t,height:i,minTextWidth:n}=this.renderEngine;this.lastUsedColor=null,this.reclusterizeClusteredFlatTree();const s=n=>s=>{const{start:r,duration:o,level:h}=s,{x:a,y:l,w:d}=this.calcRect(r,o,h);a+d>0&&a<e&&l+t>0&&l<i&&n(s,a,l,d)},r=(e,i,n,s)=>{this.interactionsEngine.addHitRegion("cluster",e,i,n,s,t)};if(this.actualClusterizedFlatTree.forEach(s(((e,i,s,o)=>{const{type:h,nodes:a,color:l}=e,d=this.interactionsEngine.getMouse();d.y>=s&&d.y<=s+t&&r(e,i,s,o),o>=.25&&this.renderEngine.addRectToRenderQueue(this.getColor(h,l),i,s,o),o>=n&&1===a.length&&this.renderEngine.addTextToRenderQueue(a[0].source.name,i,s,o)}))),this.selectedRegion&&"node"===this.selectedRegion.type){const{source:{start:e,duration:t},level:i}=this.selectedRegion.data,{x:n,y:s,w:r}=this.calcRect(e,t,i);this.renderEngine.addStrokeToRenderQueue("green",n,s,r,this.renderEngine.blockHeight)}clearTimeout(this.renderChartTimeout),this.renderChartTimeout=window.setTimeout((()=>{this.interactionsEngine.clearHitRegions(),this.actualClusterizedFlatTree.forEach(s(r))}),16)}}const ye={font:"10px sans-serif",fontColor:"black"};class xe extends g{constructor(e={}){super("timeGridPlugin"),this.styles=ye,this.height=0,this.setSettings(e)}setSettings({styles:e}){this.styles=m(ye,e),this.renderEngine&&this.overrideEngineSettings()}overrideEngineSettings(){this.renderEngine.setSettingsOverrides({styles:this.styles}),this.height=Math.round(this.renderEngine.charHeight+10)}init(e,t){super.init(e,t),this.overrideEngineSettings()}render(){return this.renderEngine.parent.timeGrid.renderTimes(this.renderEngine),this.renderEngine.parent.timeGrid.renderLines(0,this.renderEngine.height,this.renderEngine),!0}}class Ee extends g{constructor({data:e,name:t="marksPlugin"}){super(t),this.hoveredRegion=null,this.selectedRegion=null,this.marks=this.prepareMarks(e),this.calcMinMax()}calcMinMax(){const{marks:e}=this;e.length&&(this.min=e.reduce(((e,{timestamp:t})=>t<e?t:e),e[0].timestamp),this.max=e.reduce(((e,{timestamp:t})=>t>e?t:e),e[0].timestamp))}init(e,t){super.init(e,t),this.interactionsEngine.on("hover",this.handleHover.bind(this)),this.interactionsEngine.on("select",this.handleSelect.bind(this))}handleHover(e){this.hoveredRegion=e}handleSelect(e){var t;this.selectedRegion!==e&&(this.selectedRegion=e,this.emit("select",{node:null!==(t=null==e?void 0:e.data)&&void 0!==t?t:null,type:"mark"}),this.renderEngine.render())}get height(){return this.renderEngine.blockHeight+2}prepareMarks(e){return e.map((({color:e,...t})=>({...t,color:new pe(e).alpha(.7).rgb().toString()}))).sort(((e,t)=>e.timestamp-t.timestamp))}setMarks(e){this.marks=this.prepareMarks(e),this.calcMinMax(),this.renderEngine.recalcMinMax(),this.renderEngine.resetParentView()}calcMarksBlockPosition(e,t){return e>0&&t>e?t:e}render(){this.marks.reduce(((e,t)=>{const{timestamp:i,color:n,shortName:s}=t,{width:r}=this.renderEngine.ctx.measureText(s),o=r+2*this.renderEngine.blockPaddingLeftRight,h=this.renderEngine.timeToPosition(i),a=this.calcMarksBlockPosition(h,e);return this.renderEngine.addRectToRenderQueue(n,a,1,o),this.renderEngine.addTextToRenderQueue(s,a,1,o),this.interactionsEngine.addHitRegion("timestamp",t,a,1,o,this.renderEngine.blockHeight),a+o}),0)}postRender(){this.marks.forEach((e=>{const{timestamp:t,color:i}=e,n=this.renderEngine.timeToPosition(t);this.renderEngine.parent.setCtxValue("strokeStyle",i),this.renderEngine.parent.setCtxValue("lineWidth",1),this.renderEngine.parent.callCtx("setLineDash",[8,7]),this.renderEngine.parent.ctx.beginPath(),this.renderEngine.parent.ctx.moveTo(n,this.renderEngine.position),this.renderEngine.parent.ctx.lineTo(n,this.renderEngine.parent.height),this.renderEngine.parent.ctx.stroke()}))}renderTooltip(){if(this.hoveredRegion&&"timestamp"===this.hoveredRegion.type){if(!1===this.renderEngine.options.tooltip)return!0;if("function"==typeof this.renderEngine.options.tooltip)this.renderEngine.options.tooltip(this.hoveredRegion,this.renderEngine,this.interactionsEngine.getGlobalMouse());else{const{data:{fullName:e,timestamp:t}}=this.hoveredRegion,i=this.renderEngine.getAccuracy()+2,n=`${e}`,s=`${t.toFixed(i)} ${this.renderEngine.timeUnits}`;this.renderEngine.renderTooltipFromData([{text:n},{text:s}],this.interactionsEngine.getGlobalMouse())}return!0}return!1}}const be={color:"rgba(90,90,90,0.20)"};class we{constructor(e){this.styles=be,this.timeUnits="ms",this.start=0,this.end=0,this.accuracy=0,this.delta=0,this.setSettings(e)}setDefaultRenderEngine(e){this.renderEngine=e,this.timeUnits=this.renderEngine.getTimeUnits()}setSettings({styles:e}){this.styles=m(be,e),this.renderEngine&&(this.timeUnits=this.renderEngine.getTimeUnits())}recalc(){const e=this.renderEngine.max-this.renderEngine.min,t=e/(this.renderEngine.width/85),i=this.renderEngine.getRealView(),n=i/(e||1);this.delta=t/Math.pow(2,Math.floor(Math.log2(1/n))),this.start=Math.floor((this.renderEngine.positionX-this.renderEngine.min)/this.delta),this.end=Math.ceil(i/this.delta)+this.start,this.accuracy=this.calcNumberFix()}calcNumberFix(){var e;const t=(this.delta/2).toString();if(t.includes("e"))return Number(null===(e=t.match(/\d+$/))||void 0===e?void 0:e[0]);const i=t.match(/(0\.0*)/);return i?i[0].length-1:0}getTimelineAccuracy(){return this.accuracy}forEachTime(e){for(let t=this.start;t<=this.end;t++){const i=t*this.delta+this.renderEngine.min;e(this.renderEngine.timeToPosition(Number(i.toFixed(this.accuracy))),i)}}renderLines(e,t,i=this.renderEngine){i.setCtxValue("fillStyle",this.styles.color),this.forEachTime((n=>{i.fillRect(n,e,1,t)}))}renderTimes(e=this.renderEngine){e.setCtxValue("fillStyle",e.styles.fontColor),e.setCtxFont(e.styles.font),this.forEachTime(((t,i)=>{e.fillText(i.toFixed(this.accuracy)+this.timeUnits,t+e.blockPaddingLeftRight,e.charHeight)}))}}function Ce(e,t,i,n){return e.length?e.reduce(((e,{[t]:n})=>i(e,n)),e[0][t]):n}const Me=e=>e.items.map((({name:t,intervals:i,timing:n,meta:s},r)=>{const o=("string"==typeof i?e.intervals[i]:i).map((({start:e,end:t,color:i,type:s,name:r})=>({start:"string"==typeof e?n[e]:e,end:"string"==typeof t?n[t]:t,color:i,name:r,type:s}))).filter((({start:e,end:t})=>"number"==typeof e&&"number"==typeof t)),h=o.filter((({type:e})=>"block"===e)),a=Ce(h,"start",Math.min,0),l=Ce(h,"end",Math.max,0),d=Ce(o,"start",Math.min,0),c=Ce(o,"end",Math.max,0);return{intervals:o,textBlock:{start:a,end:l},name:t,timing:n,min:d,max:c,index:r,meta:s}})).filter((({intervals:e})=>e.length)).sort(((e,t)=>e.min-t.min||t.max-e.max)),Re=(e,t,i,n)=>n-(e-t)*i,ke={fillColor:"rgba(0, 0, 0, 0.1)",lineWidth:1,lineDash:[],lineColor:"rgba(0, 0, 0, 0.5)",type:"smooth"},Te=e=>{const t=[],i=e.map((e=>{var t;return{group:e.units&&!e.group?e.units:"default",...e,style:{lineWidth:1,fillColor:"rgba(0, 0, 0, 0.15)",lineColor:"rgba(0, 0, 0, 0.20)",lineDash:[],type:"smooth",...null!==(t=e.style)&&void 0!==t?t:{}}}})),n=i.reduce(((e,{points:i,group:n,min:s,max:r},o)=>(e[n]||(e[n]={min:null!=s?s:i[0][1],max:null!=r?r:i[0][1]}),t[o]={start:i[0][0],end:f(i)[0]},i.forEach((([i,h])=>{void 0===s&&(e[n].min=Math.min(e[n].min,h)),void 0===r&&(e[n].max=Math.max(e[n].max,h)),t[o].start=Math.min(t[o].start,i),t[o].end=Math.max(t[o].end,i)})),e)),{});return{summary:n,total:{min:Math.min(...t.map((({start:e})=>e))),max:Math.max(...t.map((({end:e})=>e)))},timeseries:i,timeboxes:t}},Se=(e,t,i)=>{var n,s;return t.dynamicMinMax?e.reduce(((e,[,t])=>(e.min=Math.min(e.min,t),e.max=Math.max(e.max,t),e)),{min:null!==(n=t.min)&&void 0!==n?n:1/0,max:null!==(s=t.max)&&void 0!==s?s:-1/0}):t.group?i[t.group]:{min:-1/0,max:1/0}},Pe=(e,{timeseries:t})=>{const i=t.reduce(((t,{points:i,units:n,name:s,group:r})=>{const o=Fe(i,e),h=r!==n&&"default"!==r?r:"default";let a="";return o&&(s&&(a+=s+": "),a+=o[1].toFixed(2),n&&(a+=n)),t[h]||(t[h]=[]),t[h].push(a),t}),{});return Object.entries(i).reduce(((e,[t,i])=>("default"!==t&&e.push({text:t,color:"black"}),i.forEach((t=>{e.push({text:t})})),e)),[])},ze=({engine:e,points:t,style:i,min:n,max:s})=>{const r={...ke,...null!=i?i:{}};e.setCtxValue("strokeStyle",r.lineColor),e.setCtxValue("fillStyle",r.fillColor),e.setCtxValue("lineWidth",r.lineWidth),e.callCtx("setLineDash",r.lineDash),e.ctx.beginPath();const o=(e.height-e.charHeight-4)/(s-n);if(t.length>1){const i=t.map((([t,i])=>[e.timeToPosition(t),Re(i,n,o,e.height)]));if(e.ctx.moveTo(i[0][0],e.height),e.ctx.lineTo(i[0][0],i[0][1]),"smooth"!==r.type&&r.type){if("line"===r.type)for(let t=1;t<i.length;t++)e.ctx.lineTo(i[t][0],i[t][1]);else if("bar"===r.type){for(let t=0;t<i.length;t++){const n=i[t],s=i[t-1]||n,r=i[t+1],o=(n[0]-s[0])/2,h=r?(r[0]-n[0])/2:o;e.ctx.lineTo(s[0]+o,n[1]),e.ctx.lineTo(n[0]+h,n[1]),r?e.ctx.lineTo(n[0]+h,r[1]):e.ctx.lineTo(n[0]+h,e.height)}e.ctx.lineTo(f(i)[0],e.height)}}else{for(let t=1;t<i.length-2;t++){const n=(i[t][0]+i[t+1][0])/2,s=(i[t][1]+i[t+1][1])/2;e.ctx.quadraticCurveTo(i[t][0],i[t][1],n,s)}const t=i[i.length-2],n=f(i);e.ctx.quadraticCurveTo(t[0],t[1],n[0],n[1]),e.ctx.quadraticCurveTo(n[0],n[1],n[0],e.height)}}e.ctx.closePath(),e.ctx.stroke(),e.ctx.fill()},Fe=(e,t,i=!0)=>{if(e[0][0]>=t)return i?e[0]:null;if(f(e)[0]<=t)return i?f(e):null;if(e.length<=1)return e[0];let n=0,s=e.length-1;for(;n<=s;){const i=Math.ceil((s+n)/2);if(t>=e[i-1][0]&&t<=e[i][0]){return e[Math.abs(t-e[i-1][0])<Math.abs(t-e[i][0])?i-1:i]}e[i][0]<t?n=i+1:s=i-1}return null},Le={font:"9px sans-serif",fontColor:"black",overlayColor:"rgba(112, 112, 112, 0.5)",graphStrokeColor:"rgba(0, 0, 0, 0.10)",graphFillColor:"rgba(0, 0, 0, 0.15)",flameChartGraphType:"smooth",waterfallStrokeOpacity:.4,waterfallFillOpacity:.35,waterfallGraphType:"smooth",bottomLineColor:"rgba(0, 0, 0, 0.25)",knobColor:"rgb(131, 131, 131)",knobStrokeColor:"white",knobSize:6,height:60,backgroundColor:"white"};class He extends g{constructor({waterfall:e,flameChartNodes:t,timeseries:i,settings:n,name:s="timeframeSelectorPlugin"}){super(s),this.styles=Le,this.height=0,this.leftKnobMoving=!1,this.rightKnobMoving=!1,this.selectingActive=!1,this.startSelectingPosition=0,this.actualClusters=[],this.clusters=[],this.flameChartMaxLevel=0,this.flameChartDots=[],this.waterfallDots=[],this.waterfallMaxLevel=0,this.actualClusterizedFlatTree=[],this.hoveredRegion=null,this.flameChartNodes=t,this.waterfall=e,this.timeseries=i,this.shouldRender=!0,this.setSettings(n)}init(e,t){super.init(e,t),this.interactionsEngine.on("down",this.handleMouseDown.bind(this)),this.interactionsEngine.on("up",this.handleMouseUp.bind(this)),this.interactionsEngine.on("move",this.handleMouseMove.bind(this)),this.interactionsEngine.on("hover",this.handleHover.bind(this)),this.setSettings()}handleHover(e){this.hoveredRegion=e}handleMouseDown(e,t){e&&("timeframeKnob"===e.type?("left"===e.data?this.leftKnobMoving=!0:this.rightKnobMoving=!0,this.interactionsEngine.setCursor("ew-resize")):"timeframeArea"===e.type&&(this.selectingActive=!0,this.startSelectingPosition=t.x))}handleMouseUp(e,t,i){let n=!1;if(this.timeout&&(n=!0),clearTimeout(this.timeout),this.timeout=window.setTimeout((()=>this.timeout=void 0),300),this.leftKnobMoving=!1,this.rightKnobMoving=!1,this.interactionsEngine.clearCursor(),this.selectingActive&&!i&&this.applyChanges(),this.selectingActive=!1,i&&!n){const e=this.getRightKnobPosition(),i=this.getLeftKnobPosition();t.x>e||t.x>i&&t.x<e&&t.x-i>e-t.x?this.setRightKnobPosition(t.x):this.setLeftKnobPosition(t.x),this.applyChanges()}n&&(this.renderEngine.parent.setZoom(this.renderEngine.getInitialZoom()),this.renderEngine.parent.setPositionX(this.renderEngine.min),this.renderEngine.parent.render())}handleMouseMove(e,t){this.leftKnobMoving&&(this.setLeftKnobPosition(t.x),this.applyChanges()),this.rightKnobMoving&&(this.setRightKnobPosition(t.x),this.applyChanges()),this.selectingActive&&(this.startSelectingPosition>=t.x?(this.setLeftKnobPosition(t.x),this.setRightKnobPosition(this.startSelectingPosition)):(this.setRightKnobPosition(t.x),this.setLeftKnobPosition(this.startSelectingPosition)),this.renderEngine.render())}postInit(){this.offscreenRenderEngine=this.renderEngine.makeChild(),this.offscreenRenderEngine.setSettingsOverrides({styles:this.styles}),this.timeGrid=new we({styles:this.renderEngine.parent.timeGrid.styles}),this.timeGrid.setDefaultRenderEngine(this.offscreenRenderEngine),this.offscreenRenderEngine.on("resize",(()=>{this.offscreenRenderEngine.setZoom(this.renderEngine.getInitialZoom()),this.offscreenRender()})),this.offscreenRenderEngine.on("min-max-change",(()=>this.shouldRender=!0)),this.setData({flameChartNodes:this.flameChartNodes,waterfall:this.waterfall,timeseries:this.timeseries})}setLeftKnobPosition(e){if(e<this.getRightKnobPosition()-1){const t=this.renderEngine.getRealView(),i=this.renderEngine.setPositionX(this.offscreenRenderEngine.pixelToTime(e)+this.renderEngine.min),n=this.renderEngine.width/(t-i);this.renderEngine.setZoom(n)}}setRightKnobPosition(e){if(e>this.getLeftKnobPosition()+1){const t=this.renderEngine.getRealView(),i=this.renderEngine.positionX+t-(this.offscreenRenderEngine.pixelToTime(e)+this.renderEngine.min),n=this.renderEngine.width/(t-i);this.renderEngine.setZoom(n)}}getLeftKnobPosition(){return(this.renderEngine.positionX-this.renderEngine.min)*this.renderEngine.getInitialZoom()}getRightKnobPosition(){return(this.renderEngine.positionX-this.renderEngine.min+this.renderEngine.getRealView())*this.renderEngine.getInitialZoom()}applyChanges(){this.renderEngine.parent.setPositionX(this.renderEngine.positionX),this.renderEngine.parent.setZoom(this.renderEngine.zoom),this.renderEngine.parent.render()}setSettings({styles:e}={styles:this.styles}){this.styles=m(Le,e),this.height=this.styles.height,this.offscreenRenderEngine&&(this.offscreenRenderEngine.setSettingsOverrides({styles:this.styles}),this.timeGrid.setSettings({styles:this.renderEngine.parent.timeGrid.styles})),this.shouldRender=!0}makeFlameChartDots(){if(this.flameChartNodes){const e=[],t=y(this.flameChartNodes),{min:i,max:n}=x(t);this.min=i,this.max=n,this.clusters=w(t,(()=>!0)),this.actualClusters=C(this.clusters,this.renderEngine.zoom,this.min,this.max,2,1/0),this.actualClusterizedFlatTree=M(this.actualClusters,this.renderEngine.zoom,this.min,this.max,2,1/0).sort(((e,t)=>e.start-t.start)),this.actualClusterizedFlatTree.forEach((({start:t,end:i})=>{e.push({time:t,type:"start"},{time:i,type:"end"})})),e.sort(((e,t)=>e.time-t.time));const{dots:s,maxLevel:r}=this.makeRenderDots(e);this.flameChartDots=s,this.flameChartMaxLevel=r}}makeRenderDots(e){const t=[];let i=0,n=0;return e.forEach((({type:e,time:s})=>{"start"!==e&&"end"!==e||t.push([s,i]),"start"===e?i++:i--,n=Math.max(n,i),t.push([s,i])})),{dots:t,maxLevel:n}}makeWaterfallDots(){if(this.waterfall){const e=Me(this.waterfall),t=Object.entries(e.reduce(((e,{intervals:t})=>(t.forEach((t=>{e[t.color]||(e[t.color]=[]),e[t.color].push(t)})),e)),{})).map((([e,t])=>{const i=[];return t.forEach((({start:e,end:t})=>{i.push({type:"start",time:e}),i.push({type:"end",time:t})})),i.sort(((e,t)=>e.time-t.time)),{color:e,points:i}}));let i=0;this.waterfallDots=t.map((({color:e,points:t})=>{const{dots:n,maxLevel:s}=this.makeRenderDots(t);return i=Math.max(i,s),{color:e,dots:n}})),this.waterfallMaxLevel=i}}prepareTimeseries(){var e;(null===(e=this.timeseries)||void 0===e?void 0:e.length)?this.preparedTimeseries=Te(this.timeseries):this.preparedTimeseries=void 0}setData({flameChartNodes:e,waterfall:t,timeseries:i}){this.flameChartNodes=e,this.waterfall=t,this.timeseries=i,this.makeFlameChartDots(),this.makeWaterfallDots(),this.prepareTimeseries(),this.offscreenRender()}setTimeseries(e){this.timeseries=e,this.prepareTimeseries(),this.offscreenRender()}setFlameChartNodes(e){this.flameChartNodes=e,this.makeFlameChartDots(),this.offscreenRender()}setWaterfall(e){this.waterfall=e,this.makeWaterfallDots(),this.offscreenRender()}offscreenRender(){const e=this.offscreenRenderEngine.getInitialZoom();if(this.offscreenRenderEngine.setZoom(e),this.offscreenRenderEngine.setPositionX(this.offscreenRenderEngine.min),this.offscreenRenderEngine.clear(),this.timeGrid.recalc(),this.timeGrid.renderLines(0,this.offscreenRenderEngine.height),this.timeGrid.renderTimes(),ze({engine:this.offscreenRenderEngine,points:this.flameChartDots,min:0,max:this.flameChartMaxLevel,style:{lineColor:this.styles.graphStrokeColor,fillColor:this.styles.graphFillColor,type:this.styles.flameChartGraphType}}),this.waterfallDots.forEach((({color:e,dots:t})=>{const i=new pe(e);ze({engine:this.offscreenRenderEngine,points:t,min:0,max:this.waterfallMaxLevel,style:{lineColor:i.alpha(this.styles.waterfallStrokeOpacity).rgb().toString(),fillColor:i.alpha(this.styles.waterfallFillOpacity).rgb().toString(),type:this.styles.waterfallGraphType}})})),this.preparedTimeseries){const{summary:e,timeseries:t}=this.preparedTimeseries;t.forEach((t=>{const i=Se(t.points,t,e);ze({engine:this.offscreenRenderEngine,points:t.points,min:i.min,max:i.max,style:t.style})}))}this.offscreenRenderEngine.setCtxValue("fillStyle",this.styles.bottomLineColor),this.offscreenRenderEngine.ctx.fillRect(0,this.height-1,this.offscreenRenderEngine.width,1)}renderTimeframe(){const e=this.renderEngine.positionX-this.renderEngine.min,t=e*this.renderEngine.getInitialZoom(),i=(e+this.renderEngine.getRealView())*this.renderEngine.getInitialZoom(),n=t-this.styles.knobSize/2,s=i-this.styles.knobSize/2,r=this.renderEngine.height/3;this.renderEngine.setCtxValue("fillStyle",this.styles.overlayColor),this.renderEngine.fillRect(0,0,t,this.renderEngine.height),this.renderEngine.fillRect(i,0,this.renderEngine.width-i,this.renderEngine.height),this.renderEngine.setCtxValue("fillStyle",this.styles.overlayColor),this.renderEngine.fillRect(t-1,0,1,this.renderEngine.height),this.renderEngine.fillRect(i+1,0,1,this.renderEngine.height),this.renderEngine.setCtxValue("fillStyle",this.styles.knobColor),this.renderEngine.fillRect(n,0,this.styles.knobSize,r),this.renderEngine.fillRect(s,0,this.styles.knobSize,r),this.renderEngine.renderStroke(this.styles.knobStrokeColor,n,0,this.styles.knobSize,r),this.renderEngine.renderStroke(this.styles.knobStrokeColor,s,0,this.styles.knobSize,r),this.interactionsEngine.addHitRegion("timeframeKnob","left",n,0,this.styles.knobSize,r,"ew-resize"),this.interactionsEngine.addHitRegion("timeframeKnob","right",s,0,this.styles.knobSize,r,"ew-resize"),this.interactionsEngine.addHitRegion("timeframeArea",null,0,0,this.renderEngine.width,this.renderEngine.height,"text")}renderTooltip(){if(this.hoveredRegion){const e=this.interactionsEngine.getMouse().x/this.renderEngine.getInitialZoom()+this.renderEngine.min,t=`${e.toFixed(this.renderEngine.getAccuracy()+2)} ${this.renderEngine.timeUnits}`,i=this.preparedTimeseries?Pe(e,this.preparedTimeseries):[];return this.renderEngine.renderTooltipFromData([{text:t},...i],this.interactionsEngine.getGlobalMouse()),!0}return!1}render(){return this.shouldRender&&(this.shouldRender=!1,this.offscreenRender()),this.renderEngine.copy(this.offscreenRenderEngine),this.renderTimeframe(),this.interactionsEngine.addHitRegion("timeframe",null,0,0,this.renderEngine.width,this.height),!0}}const De={defaultHeight:68};class Ae extends g{constructor({data:e,name:t="waterfallPlugin",settings:i}){super(t),this.styles=De,this.height=De.defaultHeight,this.data=[],this.positionY=0,this.hoveredRegion=null,this.selectedRegion=null,this.initialData=[],this.setData(e),this.setSettings(i)}init(e,t){super.init(e,t),this.interactionsEngine.on("change-position",this.handlePositionChange.bind(this)),this.interactionsEngine.on("hover",this.handleHover.bind(this)),this.interactionsEngine.on("select",this.handleSelect.bind(this)),this.interactionsEngine.on("up",this.handleMouseUp.bind(this))}handlePositionChange({deltaX:e,deltaY:t}){const i=this.positionY,n=this.renderEngine.parent.positionX;this.interactionsEngine.setCursor("grabbing"),this.positionY+t>=0?this.setPositionY(this.positionY+t):this.setPositionY(0),this.renderEngine.tryToChangePosition(e),n===this.renderEngine.parent.positionX&&i===this.positionY||this.renderEngine.parent.render()}handleMouseUp(){this.interactionsEngine.clearCursor()}handleHover(e){this.hoveredRegion=e}handleSelect(e){this.selectedRegion!==e&&(this.selectedRegion=e,this.emit("select",{node:(null==e?void 0:e.data)?this.initialData[e.data]:null,type:"waterfall-node"}),this.renderEngine.render())}setPositionY(e){this.positionY=e}setSettings({styles:e}){this.styles=m(De,e),this.height=this.styles.defaultHeight,this.positionY=0}setData(e){this.positionY=0,this.initialData=e.items,this.data=Me(e),e.items.length&&(this.min=this.data.reduce(((e,{min:t})=>Math.min(e,t)),this.data[0].min),this.max=this.data.reduce(((e,{max:t})=>Math.max(e,t)),this.data[0].max)),this.renderEngine&&(this.renderEngine.recalcMinMax(),this.renderEngine.resetParentView())}calcRect(e,t,i){const n=t*this.renderEngine.zoom;return{x:this.renderEngine.timeToPosition(e),w:i?n<=.1?.1:n>=3?n-1:n-n/3:n}}renderTooltip(){if(this.hoveredRegion){if(!1===this.renderEngine.options.tooltip)return!0;if("function"==typeof this.renderEngine.options.tooltip){const{data:e}=this.hoveredRegion,t={...this.hoveredRegion};t.data=this.data.find((({index:t})=>e===t)),this.renderEngine.options.tooltip(t,this.renderEngine,this.interactionsEngine.getGlobalMouse())}else{const{data:e}=this.hoveredRegion,t=this.data.find((({index:t})=>e===t));if(t){const{name:e,intervals:i,timing:n,meta:s=[]}=t,r=this.renderEngine.getTimeUnits(),o=this.renderEngine.getAccuracy()+2,h={text:`${e}`},a={text:"intervals",color:this.renderEngine.styles.tooltipHeaderFontColor},l=i.map((({name:e,start:t,end:i})=>({text:`${e}: ${(i-t).toFixed(o)} ${r}`}))),d={text:"timing",color:this.renderEngine.styles.tooltipHeaderFontColor},c=Object.entries(n).filter((([,e])=>"number"==typeof e)).map((([e,t])=>({text:`${e}: ${t.toFixed(o)} ${r}`}))),u={text:"meta",color:this.renderEngine.styles.tooltipHeaderFontColor},g=s?s.map((({name:e,value:t,color:i})=>({text:`${e}: ${t}`,color:i}))):[];this.renderEngine.renderTooltipFromData([h,a,...l,d,...c,...g.length?[u,...g]:[]],this.interactionsEngine.getGlobalMouse())}}return!0}return!1}render(){const e=this.renderEngine.positionX+this.renderEngine.getRealView(),t=this.renderEngine.positionX,i=this.renderEngine.blockHeight+1,n=[];this.data.filter((({min:i,max:n})=>!(e<i&&e<n||t>n&&e>i))).map((e=>{for(;n.length&&e.min-f(n).max>0;)n.pop();const t=n.length,i={...e,level:t};return n.push(e),i})).forEach((({name:e,intervals:t,textBlock:n,level:s,index:r})=>{const o=s*i-this.positionY;if(o+i>=0&&o-i<=this.renderEngine.height){const i=this.renderEngine.timeToPosition(n.start),s=this.renderEngine.timeToPosition(n.end);this.renderEngine.addTextToRenderQueue(e,i,o,s-i);const{x:h,w:a}=t.reduce(((e,{color:i,start:n,end:s,type:r},h)=>{const{x:a,w:l}=this.calcRect(n,s-n,h===t.length-1);return"block"===r&&this.renderEngine.addRectToRenderQueue(i,a,o,l),{x:null===e.x?a:e.x,w:l+e.w}}),{x:null,w:0});if(this.selectedRegion&&"waterfall-node"===this.selectedRegion.type){this.selectedRegion.data===r&&this.renderEngine.addStrokeToRenderQueue("green",null!=h?h:0,o,a,this.renderEngine.blockHeight)}this.interactionsEngine.addHitRegion("waterfall-node",r,null!=h?h:0,o,a,this.renderEngine.blockHeight)}}),0)}}const Ge={height:16,color:"rgb(202,202,202, 0.25)",strokeColor:"rgb(138,138,138, 0.50)",dotsColor:"rgb(97,97,97)",fontColor:"black",font:"10px sans-serif",triangleWidth:10,triangleHeight:7,triangleColor:"black",leftPadding:10};class Xe extends g{constructor(e,t){super("togglePlugin"),this.styles=Ge,this.height=0,this.resizeActive=!1,this.resizeStartHeight=0,this.resizeStartPosition=0,this.setSettings(t),this.title=e}setSettings({styles:e}={}){this.styles=m(Ge,e),this.height=this.styles.height+1}init(e,t){super.init(e,t);this.getNextEngine().setFlexible(),this.interactionsEngine.on("click",(e=>{if(e&&"toggle"===e.type&&e.data===this.renderEngine.id){const e=this.getNextEngine();e.collapsed?e.expand():e.collapse(),this.renderEngine.parent.recalcChildrenSizes(),this.renderEngine.parent.render()}})),this.interactionsEngine.on("down",(e=>{if(e&&"knob-resize"===e.type&&e.data===this.renderEngine.id){const e=this.getPrevEngine();this.interactionsEngine.setCursor("row-resize"),this.resizeActive=!0,this.resizeStartHeight=e.height,this.resizeStartPosition=this.interactionsEngine.getGlobalMouse().y}})),this.interactionsEngine.parent.on("move",(()=>{if(this.resizeActive){const e=this.getPrevEngine(),t=this.interactionsEngine.getGlobalMouse();if(e.flexible){const i=this.resizeStartHeight-(this.resizeStartPosition-t.y);i<=0?(e.collapse(),e.resize({height:0})):(e.collapsed&&e.expand(),e.resize({height:i})),this.renderEngine.parent.render()}}})),this.interactionsEngine.parent.on("up",(()=>{this.interactionsEngine.clearCursor(),this.resizeActive=!1}))}getPrevEngine(){var e;const t=(null!==(e=this.renderEngine.id)&&void 0!==e?e:0)-1;return this.renderEngine.parent.children[t]}getNextEngine(){var e;const t=(null!==(e=this.renderEngine.id)&&void 0!==e?e:0)+1;return this.renderEngine.parent.children[t]}render(){const e=this.getNextEngine(),t=this.getPrevEngine(),i=this.styles.leftPadding+this.styles.triangleWidth,n=this.renderEngine.width/2,s=this.styles.height/2;this.renderEngine.setCtxFont(this.styles.font),this.renderEngine.setCtxValue("fillStyle",this.styles.color),this.renderEngine.setCtxValue("strokeStyle",this.styles.strokeColor),this.renderEngine.fillRect(0,0,this.renderEngine.width,this.styles.height),this.renderEngine.setCtxValue("fillStyle",this.styles.fontColor),this.renderEngine.addTextToRenderQueue(this.title,i,0,this.renderEngine.width),this.renderEngine.renderTriangle(this.styles.triangleColor,this.styles.leftPadding,this.styles.height/2,this.styles.triangleWidth,this.styles.triangleHeight,e.collapsed?"right":"bottom");const{width:r}=this.renderEngine.ctx.measureText(this.title),o=r+i;this.interactionsEngine.addHitRegion("toggle",this.renderEngine.id,0,0,o,this.styles.height,"pointer"),t.flexible&&(this.renderEngine.renderCircle(this.styles.dotsColor,n,s,1.5),this.renderEngine.renderCircle(this.styles.dotsColor,n-10,s,1.5),this.renderEngine.renderCircle(this.styles.dotsColor,n+10,s,1.5),this.interactionsEngine.addHitRegion("knob-resize",this.renderEngine.id,o,0,this.renderEngine.width-o,this.styles.height,"row-resize"))}}const Oe="QWERTYUIOPASDFGHJKLZXCVBNMqwertyuiopasdfghjklzxcvbnm1234567890_-+()[]{}\\/|'\";:.,?~";const Ve={tooltip:void 0,timeUnits:"ms"},Ue={blockHeight:16,blockPaddingLeftRight:4,backgroundColor:"white",font:"10px sans-serif",fontColor:"black",tooltipHeaderFontColor:"black",tooltipBodyFontColor:"#688f45",tooltipBackgroundColor:"white",tooltipShadowColor:"black",tooltipShadowBlur:6,tooltipShadowOffsetX:0,tooltipShadowOffsetY:0,headerHeight:14,headerColor:"rgba(112, 112, 112, 0.25)",headerStrokeColor:"rgba(112, 112, 112, 0.5)",headerTitleLeftPadding:16};class Ie extends i{constructor(e,t){super(),this.options=Ve,this.timeUnits="ms",this.styles=Ue,this.blockPaddingLeftRight=0,this.blockHeight=0,this.blockPaddingTopBottom=0,this.charHeight=0,this.placeholderWidth=0,this.avgCharWidth=0,this.minTextWidth=0,this.textRenderQueue=[],this.strokeRenderQueue=[],this.rectRenderQueue={},this.zoom=0,this.positionX=0,this.min=0,this.max=0,this.ctxCachedSettings={},this.ctxCachedCalls={},this.setCtxValue=(e,t)=>{this.ctxCachedSettings[e]!==t&&(this.ctx[e]=t,this.ctxCachedSettings[e]=t)},this.callCtx=(e,t)=>{this.ctxCachedCalls[e]&&this.ctxCachedCalls[e]===t||(this.ctx[e](t),this.ctxCachedCalls[e]=t)},this.width=e.width,this.height=e.height,this.isSafari=(()=>{const e=navigator.userAgent.toLowerCase();return!!e.includes("safari")&&!e.includes("chrome")})(),this.canvas=e,this.ctx=e.getContext("2d",{alpha:!1}),this.pixelRatio=function(e){const t=e;return(window.devicePixelRatio||1)/(t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1)}(this.ctx),this.setSettings(t),this.applyCanvasSize(),this.reset()}setSettings({options:e,styles:t}){this.options=m(Ve,e),this.styles=m(Ue,t),this.timeUnits=this.options.timeUnits,this.blockHeight=this.styles.blockHeight,this.ctx.font=this.styles.font;const{actualBoundingBoxAscent:i,actualBoundingBoxDescent:n,width:s}=this.ctx.measureText(Oe),{width:r}=this.ctx.measureText("…"),o=i+n;this.blockPaddingLeftRight=this.styles.blockPaddingLeftRight,this.blockPaddingTopBottom=Math.ceil((this.blockHeight-o)/2),this.charHeight=o+1,this.placeholderWidth=r,this.avgCharWidth=s/Oe.length,this.minTextWidth=this.avgCharWidth+this.placeholderWidth}reset(){this.textRenderQueue=[],this.strokeRenderQueue=[],this.rectRenderQueue={},this.ctxCachedCalls={},this.ctxCachedSettings={}}setCtxShadow(e){var t,i;this.setCtxValue("shadowBlur",e.blur),this.setCtxValue("shadowColor",e.color),this.setCtxValue("shadowOffsetY",null!==(t=e.offsetY)&&void 0!==t?t:0),this.setCtxValue("shadowOffsetX",null!==(i=e.offsetX)&&void 0!==i?i:0)}setCtxFont(e){e&&this.ctx.font!==e&&(this.ctx.font=e)}fillRect(e,t,i,n){this.ctx.fillRect(e,t,i,n)}fillText(e,t,i){this.ctx.fillText(e,t,i)}renderBlock(e,t,i,n){this.setCtxValue("fillStyle",e),this.ctx.fillRect(t,i,n,this.blockHeight)}renderStroke(e,t,i,n,s){this.setCtxValue("strokeStyle",e),this.ctx.setLineDash([]),this.ctx.strokeRect(t,i,n,s)}clear(e=this.width,t=this.height,i=0,n=0){this.setCtxValue("fillStyle",this.styles.backgroundColor),this.ctx.clearRect(i,n,e,t-1),this.ctx.fillRect(i,n,e,t),this.ctxCachedCalls={},this.ctxCachedSettings={},this.emit("clear")}timeToPosition(e){return e*this.zoom-this.positionX*this.zoom}pixelToTime(e){return e/this.zoom}setZoom(e){this.zoom=e}setPositionX(e){const t=this.positionX;return this.positionX=e,e-t}addRectToRenderQueue(e,t,i,n){this.rectRenderQueue[e]||(this.rectRenderQueue[e]=[]),this.rectRenderQueue[e].push({x:t,y:i,w:n})}addTextToRenderQueue(e,t,i,n){if(e){const s=n-(2*this.blockPaddingLeftRight-(t<0?t:0));s>0&&this.textRenderQueue.push({text:e,x:t,y:i,w:n,textMaxWidth:s})}}addStrokeToRenderQueue(e,t,i,n,s){this.strokeRenderQueue.push({color:e,x:t,y:i,w:n,h:s})}resolveRectRenderQueue(){Object.entries(this.rectRenderQueue).forEach((([e,t])=>{this.setCtxValue("fillStyle",e),t.forEach((({x:t,y:i,w:n})=>this.renderBlock(e,t,i,n)))})),this.rectRenderQueue={}}resolveTextRenderQueue(){this.setCtxValue("fillStyle",this.styles.fontColor),this.textRenderQueue.forEach((({text:e,x:t,y:i,textMaxWidth:n})=>{const{width:s}=this.ctx.measureText(e);if(s>n){const t=s/e.length,i=(Math.floor((n-this.placeholderWidth)/t)-1)/2;e=i>0?e.slice(0,Math.ceil(i))+"…"+e.slice(e.length-Math.floor(i),e.length):""}e&&this.ctx.fillText(e,(t<0?0:t)+this.blockPaddingLeftRight,i+this.blockHeight-this.blockPaddingTopBottom)})),this.textRenderQueue=[]}resolveStrokeRenderQueue(){this.strokeRenderQueue.forEach((({color:e,x:t,y:i,w:n,h:s})=>{this.renderStroke(e,t,i,n,s)})),this.strokeRenderQueue=[]}setMinMax(e,t){const i=e!==this.min||t!==this.max;this.min=e,this.max=t,i&&this.emit("min-max-change",e,t)}getTimeUnits(){return this.timeUnits}tryToChangePosition(e){const t=this.getRealView();this.positionX+e+t<=this.max&&this.positionX+e>=this.min?this.setPositionX(this.positionX+e):this.positionX+e<=this.min?this.setPositionX(this.min):this.positionX+e+t>=this.max&&this.setPositionX(this.max-t)}getInitialZoom(){return this.max-this.min>0?this.width/(this.max-this.min):1}getRealView(){return this.width/this.zoom}resetView(){this.setZoom(this.getInitialZoom()),this.setPositionX(this.min)}resize(e,t){const i="number"==typeof e&&this.width!==e,n="number"==typeof t&&this.height!==t;return!(!i&&!n)&&(this.width=i?e:this.width,this.height=n?t:this.height,this.applyCanvasSize(),this.emit("resize",{width:this.width,height:this.height}),n)}applyCanvasSize(){this.canvas.style.backgroundColor="white",this.canvas.style.overflow="hidden",this.canvas.style.width=this.width+"px",this.canvas.style.height=this.height+"px",this.canvas.width=this.width*this.pixelRatio,this.canvas.height=this.height*this.pixelRatio,this.ctx.setTransform(this.pixelRatio,0,0,this.pixelRatio,0,0),this.ctx.font=this.styles.font}copy(e){const t=this.isSafari?1:e.pixelRatio;e.canvas.height&&this.ctx.drawImage(e.canvas,0,0,e.canvas.width*t,e.canvas.height*t,0,e.position||0,e.width*t,e.height*t)}renderTooltipFromData(e,t){const i=t.x+10,n=t.y+10,s=e.map((({text:e})=>e)).map((e=>this.ctx.measureText(e))).reduce(((e,{width:t})=>Math.max(e,t)),0)+2*this.blockPaddingLeftRight;this.setCtxShadow({color:this.styles.tooltipShadowColor,blur:this.styles.tooltipShadowBlur,offsetX:this.styles.tooltipShadowOffsetX,offsetY:this.styles.tooltipShadowOffsetY}),this.setCtxValue("fillStyle",this.styles.tooltipBackgroundColor),this.ctx.fillRect(i,n,s+2*this.blockPaddingLeftRight,(this.charHeight+2)*e.length+2*this.blockPaddingLeftRight),this.setCtxShadow({color:"transparent",blur:0}),e.forEach((({text:e,color:t},s)=>{t?this.setCtxValue("fillStyle",t):s?this.setCtxValue("fillStyle",this.styles.tooltipBodyFontColor):this.setCtxValue("fillStyle",this.styles.tooltipHeaderFontColor),this.ctx.fillText(e,i+this.blockPaddingLeftRight,n+this.blockHeight-this.blockPaddingTopBottom+(this.charHeight+2)*s)}))}renderShape(e,t,i,n){this.setCtxValue("fillStyle",e),this.ctx.beginPath(),this.ctx.moveTo(t[0].x+i,t[0].y+n),t.slice(1).forEach((({x:e,y:t})=>this.ctx.lineTo(e+i,t+n))),this.ctx.closePath(),this.ctx.fill()}renderTriangle(e,t,i,n,s,r){const o=s/2,h=n/2;let a;switch(r){case"top":a=[{x:0-h,y:o},{x:0,y:0-o},{x:h,y:o}];break;case"right":a=[{x:0-o,y:0-h},{x:0-o,y:h},{x:o,y:0}];break;case"bottom":a=[{x:0-h,y:0-o},{x:h,y:0-o},{x:0,y:o}];break;case"left":a=[{x:o,y:0-h},{x:o,y:h},{x:0-o,y:0}]}this.renderShape(e,a,t,i)}renderCircle(e,t,i,n){this.ctx.beginPath(),this.ctx.arc(t,i,n,0,2*Math.PI,!1),this.setCtxValue("fillStyle",e),this.ctx.fill()}}class Ne extends Ie{constructor({width:e,height:t,parent:i,id:n}){const s=document.createElement("canvas");s.width=e,s.height=t,super(s,{options:i.options,styles:i.styles}),this.flexible=!1,this.collapsed=!1,this.position=0,this.width=e,this.height=t,this.parent=i,this.id=n,this.children=[],this.applyCanvasSize()}makeChild(){const e=new Ne({width:this.width,height:this.height,parent:this.parent,id:void 0});return this.children.push(e),e.setMinMax(this.min,this.max),e.resetView(),e}setFlexible(){this.flexible=!0}collapse(){this.collapsed=!0,this.clear()}expand(){this.collapsed=!1}setSettingsOverrides(e){this.setSettings({styles:m(this.styles,e.styles),options:m(this.options,e.options)}),this.children.forEach((t=>t.setSettingsOverrides(e)))}resize({width:e,height:t,position:i},n){const s=super.resize(e,t);!n&&s&&this.parent.recalcChildrenSizes(),"number"==typeof i&&(this.position=i),this.children.forEach((n=>n.resize({width:e,height:t,position:i})))}setMinMax(e,t){super.setMinMax(e,t),this.children.forEach((i=>i.setMinMax(e,t)))}setSettings(e){super.setSettings(e),this.children&&this.children.forEach((t=>t.setSettings(e)))}tryToChangePosition(e){this.parent.tryToChangePosition(e)}recalcMinMax(){this.parent.calcMinMax()}getTimeUnits(){return this.parent.getTimeUnits()}getAccuracy(){return this.parent.timeGrid.accuracy}renderTimeGrid(){this.parent.timeGrid.renderLines(0,this.height,this)}renderTimeGridTimes(){this.parent.timeGrid.renderTimes(this)}standardRender(){this.resolveRectRenderQueue(),this.resolveTextRenderQueue(),this.resolveStrokeRenderQueue(),this.renderTimeGrid()}renderTooltipFromData(e,t){this.parent.renderTooltipFromData(e,t)}resetParentView(){this.parent.resetView(),this.parent.render()}render(){this.parent.partialRender(this.id)}}class _e extends Ie{constructor({canvas:e,settings:t,timeGrid:i,plugins:n}){super(e,t),this.freeSpace=0,this.lastPartialAnimationFrame=null,this.lastGlobalAnimationFrame=null,this.plugins=n,this.children=[],this.requestedRenders=[],this.timeGrid=i,this.timeGrid.setDefaultRenderEngine(this)}makeInstance(){const e=new Ne({width:this.width,height:0,id:this.children.length,parent:this});return e.setMinMax(this.min,this.max),e.resetView(),this.children.push(e),e}calcMinMax(){const e=this.plugins.map((({min:e})=>e)).filter(p).reduce(((e,t)=>Math.min(e,t))),t=this.plugins.map((({max:e})=>e)).filter(p).reduce(((e,t)=>Math.max(e,t)));this.setMinMax(e,t)}calcTimeGrid(){this.timeGrid.recalc()}setMinMax(e,t){super.setMinMax(e,t),this.children.forEach((i=>i.setMinMax(e,t)))}setSettings(e){super.setSettings(e),this.children&&(this.children.forEach((t=>t.setSettings(e))),this.recalcChildrenSizes())}resize(e,t){const i=this.width;return super.resize(e,t),this.recalcChildrenSizes(),this.getInitialZoom()>this.zoom?this.resetView():this.positionX>this.min&&this.tryToChangePosition(-this.pixelToTime((e-i)/2)),!0}recalcChildrenSizes(){const e=this.getChildrenSizes();this.freeSpace=e.reduce(((e,{height:t})=>e-t),this.height),this.children.forEach(((t,i)=>{t.resize(e[i],!0)}))}getChildrenSizes(){const e=this.children.map(((e,t)=>t)).map((e=>{const t=this.plugins[e];return this.children[e].flexible&&t.height?"flexibleStatic":t.height?"static":"flexibleGrowing"})),t=e.reduce(((e,t,i)=>{var n,s;const r=this.plugins[i],o=this.children[i];return o.collapsed?e:"flexibleGrowing"===t?e-(o.height||0):"flexibleStatic"===t?e-((null==o?void 0:o.height)||(null==r?void 0:r.height)||0):"static"===t?e-(null!==(s=null===(n=this.plugins[i])||void 0===n?void 0:n.height)&&void 0!==s?s:0):e}),this.height),i=e.filter((e=>"flexibleGrowing"===e)).length,n=Math.floor(t/i);return e.reduce(((e,t,i)=>{var s,r;const o=this.children[i],h=this.plugins[i];let a=0;if(o.collapsed)a=0;else switch(t){case"static":a=null!==(s=h.height)&&void 0!==s?s:0;break;case"flexibleGrowing":a=(o.height||0)+n;break;case"flexibleStatic":a=null!==(r=o.height||this.plugins[i].height)&&void 0!==r?r:0}return e.result.push({width:this.width,position:e.position,height:a}),e.position+=a,e}),{position:0,result:[]}).result}getAccuracy(){return this.timeGrid.accuracy}setZoom(e){return(this.getAccuracy()<6||e<=this.zoom)&&(super.setZoom(e),this.children.forEach((t=>t.setZoom(e))),!0)}setPositionX(e){const t=super.setPositionX(e);return this.children.forEach((t=>t.setPositionX(e))),t}renderPlugin(e){var t;const i=this.plugins[e],n=this.children[e];if(null==n||n.clear(),!n.collapsed){(null===(t=null==i?void 0:i.render)||void 0===t?void 0:t.call(i))||n.standardRender()}}partialRender(e){"number"==typeof e&&this.requestedRenders.push(e),this.lastPartialAnimationFrame||(this.lastPartialAnimationFrame=requestAnimationFrame((()=>{this.requestedRenders.forEach((e=>this.renderPlugin(e))),this.shallowRender(),this.requestedRenders=[],this.lastPartialAnimationFrame=null})))}shallowRender(){this.clear(),this.timeGrid.renderLines(this.height-this.freeSpace,this.freeSpace),this.children.forEach((e=>{e.collapsed||this.copy(e)}));let e=!1;this.plugins.forEach((e=>{e.postRender&&e.postRender()})),this.plugins.forEach((t=>{t.renderTooltip&&(e=e||Boolean(t.renderTooltip()))})),e||"function"!=typeof this.options.tooltip||this.options.tooltip(null,this,null)}render(e){"number"==typeof this.lastPartialAnimationFrame&&cancelAnimationFrame(this.lastPartialAnimationFrame),this.requestedRenders=[],this.lastPartialAnimationFrame=null,this.lastGlobalAnimationFrame||(this.lastGlobalAnimationFrame=requestAnimationFrame((()=>{null==e||e(),this.timeGrid.recalc(),this.children.forEach(((e,t)=>this.renderPlugin(t))),this.shallowRender(),this.lastGlobalAnimationFrame=null})))}}const je=["down","up","move","click","select"];class Qe extends i{static getId(){return Qe.count++}constructor(e,t){super(),this.id=Qe.getId(),this.parent=e,this.renderEngine=t,t.on("clear",(()=>this.clearHitRegions())),je.forEach((t=>e.on(t,((e,i,n)=>{e&&e.id!==this.id||this.resend(t,e,i,n)})))),["hover"].forEach((t=>e.on(t,((e,i)=>{e&&e.id!==this.id||this.emit(t,e,i)})))),e.on("change-position",((e,t,i,n)=>{n===this&&this.emit("change-position",e,t,i)})),this.hitRegions=[]}resend(e,...t){this.renderEngine.position<=this.parent.mouse.y&&this.renderEngine.height+this.renderEngine.position>=this.parent.mouse.y&&this.emit(e,...t)}getMouse(){const{x:e,y:t}=this.parent.mouse;return{x:e,y:t-this.renderEngine.position}}getGlobalMouse(){return this.parent.mouse}clearHitRegions(){this.hitRegions=[]}addHitRegion(e,t,i,n,s,r,o){this.hitRegions.push({type:e,data:t,x:i,y:n,w:s,h:r,cursor:o,id:this.id})}setCursor(e){this.parent.setCursor(e)}clearCursor(){this.parent.clearCursor()}}Qe.count=0;class Ye extends i{constructor(e,t){super(),this.selectedRegion=null,this.hoveredRegion=null,this.moveActive=!1,this.currentCursor=null,this.renderEngine=t,this.canvas=e,this.hitRegions=[],this.instances=[],this.mouse={x:0,y:0},this.handleMouseWheel=this.handleMouseWheel.bind(this),this.handleMouseDown=this.handleMouseDown.bind(this),this.handleMouseUp=this.handleMouseUp.bind(this),this.handleMouseMove=this.handleMouseMove.bind(this),this.initListeners(),this.reset()}makeInstance(e){const t=new Qe(this,e);return this.instances.push(t),t}reset(){this.selectedRegion=null,this.hoveredRegion=null,this.hitRegions=[]}destroy(){this.removeListeners()}initListeners(){this.canvas&&(this.canvas.addEventListener("wheel",this.handleMouseWheel),this.canvas.addEventListener("mousedown",this.handleMouseDown),this.canvas.addEventListener("mouseup",this.handleMouseUp),this.canvas.addEventListener("mouseleave",this.handleMouseUp),this.canvas.addEventListener("mousemove",this.handleMouseMove))}removeListeners(){this.canvas&&(this.canvas.removeEventListener("wheel",this.handleMouseWheel),this.canvas.removeEventListener("mousedown",this.handleMouseDown),this.canvas.removeEventListener("mouseup",this.handleMouseUp),this.canvas.removeEventListener("mouseleave",this.handleMouseUp),this.canvas.removeEventListener("mousemove",this.handleMouseMove))}handleMouseWheel(e){const{deltaY:t,deltaX:i}=e;e.preventDefault();const n=this.renderEngine.getRealView(),s=this.renderEngine.getInitialZoom(),r=this.renderEngine.positionX,o=this.renderEngine.zoom,h=i/this.renderEngine.zoom;let a=t/1e3*this.renderEngine.zoom;if(this.renderEngine.tryToChangePosition(h),a=this.renderEngine.zoom-a>=s?a:this.renderEngine.zoom-s,0!==a){if(this.renderEngine.setZoom(this.renderEngine.zoom-a)){const e=this.mouse.x/this.renderEngine.width,t=(n-this.renderEngine.width/this.renderEngine.zoom)*e;this.renderEngine.tryToChangePosition(t)}}this.checkRegionHover(),r===this.renderEngine.positionX&&o===this.renderEngine.zoom||this.renderEngine.render()}handleMouseDown(){this.moveActive=!0,this.mouseDownPosition={x:this.mouse.x,y:this.mouse.y},this.mouseDownHoveredInstance=this.hoveredInstance,this.emit("down",this.hoveredRegion,this.mouse)}handleMouseUp(){this.moveActive=!1;const e=this.mouseDownPosition&&this.mouseDownPosition.x===this.mouse.x&&this.mouseDownPosition.y===this.mouse.y;e&&this.handleRegionHit(),this.emit("up",this.hoveredRegion,this.mouse,e),e&&this.emit("click",this.hoveredRegion,this.mouse)}handleMouseMove(e){if(this.moveActive){const t=this.mouse.y-e.offsetY,i=(this.mouse.x-e.offsetX)/this.renderEngine.zoom;(t||i)&&this.emit("change-position",{deltaX:i,deltaY:t},this.mouseDownPosition,this.mouse,this.mouseDownHoveredInstance)}this.mouse.x=e.offsetX,this.mouse.y=e.offsetY,this.checkRegionHover(),this.emit("move",this.hoveredRegion,this.mouse)}handleRegionHit(){const e=this.getHoveredRegion();this.emit("select",e,this.mouse)}checkRegionHover(){const e=this.getHoveredRegion();e&&this.hoveredRegion&&e.id!==this.hoveredRegion.id&&this.emit("hover",null,this.mouse),e?(!this.currentCursor&&e.cursor?this.renderEngine.canvas.style.cursor=e.cursor:this.currentCursor||this.clearCursor(),this.hoveredRegion=e,this.emit("hover",e,this.mouse),this.renderEngine.partialRender()):this.hoveredRegion&&!e&&(this.currentCursor||this.clearCursor(),this.hoveredRegion=null,this.emit("hover",null,this.mouse),this.renderEngine.partialRender())}getHoveredRegion(){const e=this.hitRegions.find((({x:e,y:t,w:i,h:n})=>this.mouse.x>=e&&this.mouse.x<=e+i&&this.mouse.y>=t&&this.mouse.y<=t+n));if(e)return e;const t=this.instances.find((({renderEngine:e})=>e.position<=this.mouse.y&&e.height+e.position>=this.mouse.y));if(this.hoveredInstance=t,t){const e=t.renderEngine.position;return t.hitRegions.find((({x:t,y:i,w:n,h:s})=>this.mouse.x>=t&&this.mouse.x<=t+n&&this.mouse.y>=i+e&&this.mouse.y<=i+s+e))}return null}clearHitRegions(){this.hitRegions=[]}addHitRegion(e,t,i,n,s,r,o){this.hitRegions.push({type:e,data:t,x:i,y:n,w:s,h:r,cursor:o})}setCursor(e){this.renderEngine.canvas.style.cursor=e,this.currentCursor=e}clearCursor(){const e=this.getHoveredRegion();this.currentCursor=null,(null==e?void 0:e.cursor)?this.renderEngine.canvas.style.cursor=e.cursor:this.renderEngine.canvas.style.cursor=""}}class We extends i{constructor({canvas:e,plugins:t,settings:i}){var n;super();const s=null!==(n=null==i?void 0:i.styles)&&void 0!==n?n:{};this.timeGrid=new we({styles:null==s?void 0:s.timeGrid}),this.renderEngine=new _e({canvas:e,settings:{styles:null==s?void 0:s.main,options:null==i?void 0:i.options},plugins:t,timeGrid:this.timeGrid}),this.interactionsEngine=new Ye(e,this.renderEngine),this.plugins=t;const r=Array(this.plugins.length).fill(null).map((()=>{const e=this.renderEngine.makeInstance();return{renderEngine:e,interactionsEngine:this.interactionsEngine.makeInstance(e)}}));this.plugins.forEach(((e,t)=>{e.init(r[t].renderEngine,r[t].interactionsEngine)})),this.renderEngine.calcMinMax(),this.renderEngine.resetView(),this.renderEngine.recalcChildrenSizes(),this.renderEngine.calcTimeGrid(),this.plugins.forEach((e=>{var t;return null===(t=e.postInit)||void 0===t?void 0:t.call(e)})),this.renderEngine.render()}render(){this.renderEngine.render()}resize(e,t){this.renderEngine.render((()=>this.renderEngine.resize(e,t)))}execOnPlugins(e,...t){let i=0;for(;i<this.plugins.length;)this.plugins[i][e]&&this.plugins[i][e](...t),i++}setSettings(e){var t,i;this.timeGrid.setSettings({styles:null===(t=e.styles)||void 0===t?void 0:t.timeGrid}),this.renderEngine.setSettings({options:e.options,styles:null===(i=e.styles)||void 0===i?void 0:i.main}),this.plugins.forEach((t=>{var i,n;return null===(i=t.setSettings)||void 0===i?void 0:i.call(t,{styles:null===(n=e.styles)||void 0===n?void 0:n[t.name]})})),this.renderEngine.render()}setZoom(e,t){const i=this.renderEngine.width/(t-e);this.renderEngine.setPositionX(e),this.renderEngine.setZoom(i),this.renderEngine.render()}}const $e={height:56};class Ke extends g{constructor({name:e="timeseriesPlugin",data:t,settings:i}){super(e),this.height=56,this.hoveredRegion=null,this.setSettings(i),this.setData(t)}init(e,t){super.init(e,t),this.interactionsEngine.on("change-position",this.handlePositionChange.bind(this)),this.interactionsEngine.on("hover",this.handleHover.bind(this)),this.interactionsEngine.on("up",this.handleMouseUp.bind(this))}handlePositionChange(e){const t=this.renderEngine.parent.positionX;this.interactionsEngine.setCursor("grabbing"),this.renderEngine.tryToChangePosition(e.deltaX),t!==this.renderEngine.parent.positionX&&this.renderEngine.parent.render()}handleMouseUp(){this.interactionsEngine.clearCursor()}setSettings({styles:e}={styles:this.styles}){this.styles=m($e,e),this.height=this.styles.height}setData(e){const t=Te(e);this.data=t,this.min=t.total.min,this.max=t.total.max,this.renderEngine&&(this.renderEngine.recalcMinMax(),this.renderEngine.resetParentView())}handleHover(e){this.hoveredRegion=e}renderTooltip(){if(this.hoveredRegion){const e=this.interactionsEngine.getMouse().x,t=this.renderEngine.pixelToTime(e)+this.renderEngine.positionX,i=`${t.toFixed(this.renderEngine.getAccuracy()+2)} ${this.renderEngine.timeUnits}`,n=Pe(t,this.data);return this.renderEngine.renderTooltipFromData([{text:i},...n],this.interactionsEngine.getGlobalMouse()),!0}return!1}render(){if(0===this.data.timeseries.length)return;const e=this.renderEngine.positionX,t=this.renderEngine.positionX+this.renderEngine.getRealView();this.data.timeseries.forEach(((i,n)=>{if(this.data.timeboxes[n].end<e||this.data.timeboxes[n].start>t)return;const s=e<=this.data.timeboxes[n].start?0:Math.max(i.points.findIndex((([t])=>t>=e))-2,0),r=t>=this.data.timeboxes[n].end?i.points.length:i.points.findIndex((([e])=>e>=t))+2,o=i.points.slice(s,r),h=Se(o,i,this.data.summary);ze({engine:this.renderEngine,points:o,min:h.min,max:h.max,style:i.style})})),this.interactionsEngine.addHitRegion("timeseries",null,0,0,this.renderEngine.width,this.height)}}const Be={};e.EVENT_NAMES=je,e.FlameChart=class extends We{constructor({canvas:e,data:t,marks:i,waterfall:n,timeframeTimeseries:s,timeseries:r,colors:o,settings:h=Be,plugins:a=[]}){var l;const d=[],{headers:{waterfall:c="waterfall",flameChart:u="flame chart"}={}}=h,g=null!==(l=null==h?void 0:h.styles)&&void 0!==l?l:{},m=new xe({styles:null==g?void 0:g.timeGridPlugin});let p,f,v,y,x;d.push(m),r&&(x=new Ke({data:r,settings:{styles:null==g?void 0:g.timeseriesPlugin}}),d.push(x)),i&&(p=new Ee({data:i}),p.on("select",(e=>this.emit("select",e))),d.push(p)),n&&(f=new Ae({data:n,settings:{styles:null==g?void 0:g.waterfallPlugin}}),f.on("select",(e=>this.emit("select",e))),t&&d.push(new Xe(c,{styles:null==g?void 0:g.togglePlugin})),d.push(f)),t&&(y=new ve({data:t,colors:o}),y.on("select",(e=>this.emit("select",e))),n&&d.push(new Xe(u,{styles:null==g?void 0:g.togglePlugin})),d.push(y)),(t||n||s)&&(v=new He({flameChartNodes:t,waterfall:n,timeseries:s,settings:{styles:null==g?void 0:g.timeframeSelectorPlugin}}),d.unshift(v)),super({canvas:e,settings:h,plugins:[...d,...a]}),y&&v&&(this.setNodes=e=>{y&&y.setData(e),v&&v.setFlameChartNodes(e)},this.setFlameChartPosition=({x:e,y:t})=>{"number"==typeof e&&this.renderEngine.setPositionX(e),"number"==typeof t&&y&&y.setPositionY(t),this.renderEngine.render()}),p&&(this.setMarks=e=>{p&&p.setMarks(e)}),f&&(this.setWaterfall=e=>{f&&f.setData(e),v&&v.setWaterfall(e)}),x&&(this.setTimeseries=e=>{x&&x.setData(e)}),v&&(this.setTimeframeTimeseries=e=>{null==v||v.setTimeseries(e)})}},e.FlameChartContainer=We,e.FlameChartPlugin=ve,e.MarksPlugin=Ee,e.TimeGridPlugin=xe,e.TimeframeSelectorPlugin=He,e.TogglePlugin=Xe,e.UIPlugin=g,e.WaterfallPlugin=Ae}));
