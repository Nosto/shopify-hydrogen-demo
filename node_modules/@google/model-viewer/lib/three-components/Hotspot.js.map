{"version":3,"file":"Hotspot.js","sourceRoot":"","sources":["../../src/three-components/Hotspot.ts"],"names":[],"mappings":"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","sourcesContent":["/* @license\n * Copyright 2020 Google LLC. All Rights Reserved.\n * Licensed under the Apache License, Version 2.0 (the 'License');\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an 'AS IS' BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport {Matrix3, Mesh, Quaternion, Triangle, Vector3} from 'three';\nimport {CSS2DObject} from 'three/examples/jsm/renderers/CSS2DRenderer.js';\n\nimport {normalizeUnit} from '../styles/conversions.js';\nimport {NumberNode, parseExpressions} from '../styles/parsers.js';\n\nimport {ModelScene} from './ModelScene.js';\n\nexport interface HotspotVisibilityDetails {\n  visible: boolean;\n}\n\n/**\n * Hotspots are configured by slot name, and this name must begin with \"hotspot\"\n * to be recognized. The position and normal strings are in the form of the\n * camera-target attribute and default to \"0m 0m 0m\" and \"0m 1m 0m\",\n * respectively.\n */\nexport interface HotspotConfiguration {\n  name: string;\n  position?: string;\n  normal?: string;\n  surface?: string;\n}\n\nconst a = new Vector3();\nconst b = new Vector3();\nconst c = new Vector3();\nconst mat = new Matrix3();\nconst triangle = new Triangle();\nconst quat = new Quaternion();\n\n/**\n * The Hotspot object is a reference-counted slot. If decrement() returns true,\n * it should be removed from the tree so it can be garbage-collected.\n */\nexport class Hotspot extends CSS2DObject {\n  public normal: Vector3 = new Vector3(0, 1, 0);\n  public surface?: string;\n  public mesh?: Mesh;\n  public tri?: Vector3;\n  public bary?: Vector3;\n  private initialized = false;\n  private referenceCount = 1;\n  private pivot = document.createElement('div');\n  private slot: HTMLSlotElement = document.createElement('slot');\n\n  constructor(config: HotspotConfiguration) {\n    super(document.createElement('div'));\n\n    this.element.classList.add('annotation-wrapper');\n\n    this.slot.name = config.name;\n\n    this.element.appendChild(this.pivot);\n    this.pivot.appendChild(this.slot);\n\n    this.updatePosition(config.position);\n    this.updateNormal(config.normal);\n    this.surface = config.surface;\n  }\n\n  get facingCamera(): boolean {\n    return !this.element.classList.contains('hide');\n  }\n\n  /**\n   * Sets the hotspot to be in the highly visible foreground state.\n   */\n  show() {\n    if (!this.facingCamera || !this.initialized) {\n      this.updateVisibility(true);\n    }\n  }\n\n  /**\n   * Sets the hotspot to be in the diminished background state.\n   */\n  hide() {\n    if (this.facingCamera || !this.initialized) {\n      this.updateVisibility(false);\n    }\n  }\n\n  /**\n   * Call this when adding elements to the same slot to keep track.\n   */\n  increment() {\n    this.referenceCount++;\n  }\n\n  /**\n   * Call this when removing elements from the slot; returns true when the slot\n   * is unused.\n   */\n  decrement(): boolean {\n    if (this.referenceCount > 0) {\n      --this.referenceCount;\n    }\n    return this.referenceCount === 0;\n  }\n\n  /**\n   * Change the position of the hotspot to the input string, in the same format\n   * as the data-position attribute.\n   */\n  updatePosition(position?: string) {\n    if (position == null)\n      return;\n    const positionNodes = parseExpressions(position)[0].terms;\n    for (let i = 0; i < 3; ++i) {\n      this.position.setComponent(\n          i, normalizeUnit(positionNodes[i] as NumberNode<'m'>).number);\n    }\n    this.updateMatrixWorld();\n  }\n\n  /**\n   * Change the hotspot's normal to the input string, in the same format as the\n   * data-normal attribute.\n   */\n  updateNormal(normal?: string) {\n    if (normal == null)\n      return;\n    const normalNodes = parseExpressions(normal)[0].terms;\n    for (let i = 0; i < 3; ++i) {\n      this.normal.setComponent(i, (normalNodes[i] as NumberNode).number);\n    }\n  }\n\n  updateSurface() {\n    const {mesh, tri, bary} = this;\n    if (mesh == null || tri == null || bary == null) {\n      return;\n    }\n\n    (mesh as any).getVertexPosition(tri.x, a);\n    (mesh as any).getVertexPosition(tri.y, b);\n    (mesh as any).getVertexPosition(tri.z, c);\n\n    a.toArray(mat.elements, 0);\n    b.toArray(mat.elements, 3);\n    c.toArray(mat.elements, 6);\n    this.position.copy(bary).applyMatrix3(mat);\n    const target = this.parent!;\n    target.worldToLocal(mesh.localToWorld(this.position));\n\n    triangle.set(a, b, c);\n    triangle.getNormal(this.normal).transformDirection(mesh.matrixWorld);\n    const pivot = target.parent as ModelScene;\n    quat.setFromAxisAngle(a.set(0, 1, 0), -pivot.rotation.y);\n    this.normal.applyQuaternion(quat);\n  }\n\n  orient(radians: number) {\n    this.pivot.style.transform = `rotate(${radians}rad)`;\n  }\n\n  updateVisibility(show: boolean) {\n    this.element.classList.toggle('hide', !show);\n\n    // NOTE: ShadyDOM doesn't support slot.assignedElements, otherwise we could\n    // use that here.\n    this.slot.assignedNodes().forEach((node) => {\n      if (node.nodeType !== Node.ELEMENT_NODE) {\n        return;\n      }\n\n      const element = node as HTMLElement;\n      // Visibility attribute can be configured per-node in the hotspot:\n      const visibilityAttribute = element.dataset.visibilityAttribute;\n\n      if (visibilityAttribute != null) {\n        const attributeName = `data-${visibilityAttribute}`;\n\n        element.toggleAttribute(attributeName, show);\n      }\n\n      element.dispatchEvent(new CustomEvent('hotspot-visibility', {\n        detail: {\n          visible: show,\n        },\n      }));\n    });\n\n    this.initialized = true;\n  }\n}"]}